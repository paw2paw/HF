{
  "id": "PIPELINE-001",
  "title": "Pipeline Stage Configuration",
  "version": "1.0",
  "status": "Active",
  "date": "2026-02-09",
  "domain": "pipeline",
  "specType": "SYSTEM",
  "outputType": "SUPERVISE",
  "specRole": "ORCHESTRATE",
  "isDeletable": false,

  "story": {
    "asA": "pipeline orchestrator",
    "iWant": "to define the order and grouping of pipeline stages",
    "soThat": "specs are executed in the correct sequence with proper batching"
  },

  "context": {
    "applies": "When the analysis pipeline executes after a call",
    "dependsOn": [],
    "assumptions": [
      "Specs are grouped by outputType and executed in stage order",
      "Batched stages can process multiple specs in a single AI call",
      "Some stages only run in specific modes (prep vs prompt)"
    ]
  },

  "parameters": [
    {
      "id": "pipeline_stages",
      "name": "Pipeline Stage Configuration",
      "description": "Defines the order and grouping of pipeline stages. Specs are grouped by outputType and executed in stage order.",
      "config": {
        "stages": [
          {
            "name": "EXTRACT",
            "order": 10,
            "outputTypes": ["LEARN", "MEASURE"],
            "description": "Extract caller data: memories and personality scores",
            "batched": true
          },
          {
            "name": "SCORE_AGENT",
            "order": 20,
            "outputTypes": ["MEASURE_AGENT"],
            "description": "Score agent behavior in the call",
            "batched": true
          },
          {
            "name": "AGGREGATE",
            "order": 30,
            "outputTypes": ["AGGREGATE"],
            "description": "Aggregate scores into personality profiles"
          },
          {
            "name": "REWARD",
            "order": 40,
            "outputTypes": ["REWARD"],
            "description": "Compute reward scores from measurements"
          },
          {
            "name": "ADAPT",
            "order": 50,
            "outputTypes": ["ADAPT"],
            "description": "Compute personalized targets for next call"
          },
          {
            "name": "SUPERVISE",
            "order": 60,
            "outputTypes": ["SUPERVISE"],
            "description": "Validate and clamp targets to safe ranges"
          },
          {
            "name": "COMPOSE",
            "order": 100,
            "outputTypes": ["COMPOSE"],
            "description": "Build the final prompt from gathered context",
            "requiresMode": "prompt"
          }
        ]
      }
    }
  ],

  "acceptanceCriteria": [
    {
      "id": "AC-PIPE-1",
      "title": "Stage Ordering",
      "given": "Multiple pipeline stages defined",
      "when": "Pipeline executes",
      "then": "Stages run in ascending order by 'order' field"
    },
    {
      "id": "AC-PIPE-2",
      "title": "OutputType Matching",
      "given": "Specs with various outputTypes",
      "when": "A stage runs",
      "then": "Only specs matching the stage's outputTypes are processed"
    },
    {
      "id": "AC-PIPE-3",
      "title": "Mode Filtering",
      "given": "A stage with requiresMode='prompt'",
      "when": "Pipeline runs in 'prep' mode",
      "then": "That stage is skipped"
    }
  ],

  "constraints": [
    {
      "id": "C-PIPE-1",
      "type": "ordering",
      "description": "Stage order values must be unique",
      "severity": "error"
    },
    {
      "id": "C-PIPE-2",
      "type": "completeness",
      "description": "All outputTypes used by specs must be covered by at least one stage",
      "severity": "warning"
    }
  ],

  "implementation": {
    "loader": "lib/pipeline/config.ts",
    "api": "/api/pipeline/stages",
    "usage": {
      "pipeline_execution": "Loaded by pipeline/route.ts to determine stage execution order",
      "supervisor_ui": "Loaded by /api/supervisor to organize specs by stage",
      "flow_visualizer": "Loaded by FlowVisualizer component to render pipeline diagram"
    }
  }
}
