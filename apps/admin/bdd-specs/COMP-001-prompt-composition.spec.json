{
  "id": "COMP-001",
  "title": "Next Call Prompt Composition",
  "version": "2.0",
  "status": "Active",
  "date": "2026-01-30",
  "domain": "prompt-composition",
  "specType": "SYSTEM",
  "outputType": "COMPOSE",
  "story": {
    "asA": "prompt composer",
    "iWant": "to assemble personalized agent guidance for each caller",
    "soThat": "the agent enters each call with relevant context and appropriate behavioral targets"
  },
  "context": {
    "applies": "Before each call - assembles final prompt from all gathered context",
    "dependsOn": [
      "PERS-001",
      "MEM-001",
      "ADAPT-PERS-001",
      "ADAPT-ENG-001",
      "SESSION-001",
      "CURR-001",
      "GOAL-001"
    ],
    "assumptions": [
      "Personality measurements are available",
      "Relevant memories have been extracted",
      "Adaptation targets have been computed",
      "Session context has been assembled",
      "Curriculum progress is tracked via CallerAttributes",
      "Learner goals are stored in memories or attributes"
    ]
  },
  "acceptanceCriteria": [
    {
      "id": "AC-COMP-1",
      "title": "Personality Section Assembly",
      "given": "Caller has personality measurements",
      "when": "Prompt composition runs",
      "then": "Personality-based communication guidance is included",
      "measuredBy": [
        "personality_section"
      ]
    },
    {
      "id": "AC-COMP-2",
      "title": "Memory Section Assembly",
      "given": "Caller has extracted memories",
      "when": "Prompt composition runs",
      "then": "Relevant memories are included with appropriate categorization",
      "measuredBy": [
        "memory_section"
      ]
    },
    {
      "id": "AC-COMP-3",
      "title": "Behavior Targets Assembly",
      "given": "Adaptation specs have computed targets",
      "when": "Prompt composition runs",
      "then": "Behavioral targets are included with guidance text",
      "measuredBy": [
        "behavior_targets_section"
      ]
    },
    {
      "id": "AC-COMP-4",
      "title": "Session Context Assembly",
      "given": "Session planning has run",
      "when": "Prompt composition runs",
      "then": "Session goals and continuity context are included",
      "measuredBy": [
        "session_context_section"
      ]
    },
    {
      "id": "AC-COMP-5",
      "title": "Recent History Assembly",
      "given": "Caller has previous calls",
      "when": "Prompt composition runs",
      "then": "Relevant recent call summaries are included",
      "measuredBy": [
        "recent_history_section"
      ]
    },
    {
      "id": "AC-COMP-6",
      "title": "Curriculum Progress Assembly",
      "given": "Caller has curriculum tracking data",
      "when": "Prompt composition runs",
      "then": "Current module, mastery level, and next content are included",
      "measuredBy": [
        "curriculum_section"
      ]
    },
    {
      "id": "AC-COMP-7",
      "title": "Learner Goals Assembly",
      "given": "Caller has learning goals defined",
      "when": "Prompt composition runs",
      "then": "Active goals and session objectives are included",
      "measuredBy": [
        "learner_goals_section"
      ]
    },
    {
      "id": "AC-COMP-8",
      "title": "Domain Context Assembly",
      "given": "Caller is assigned to a domain",
      "when": "Prompt composition runs",
      "then": "Domain-specific attributes and context are included",
      "measuredBy": [
        "domain_context_section"
      ]
    }
  ],
  "parameters": [
    {
      "id": "prompt_preamble",
      "name": "Prompt Interpretation Guide",
      "description": "Meta-instructions that teach the LLM how to interpret and use the structured prompt data",
      "section": "meta",
      "config": {
        "systemInstruction": "You are receiving a structured context package for your next conversation. This data has been assembled specifically for this caller based on their history, personality, and learning progress. Use it to deliver a personalized, effective session.",
        "sectionGuide": {
          "session_pedagogy": {
            "priority": "HIGHEST - This is your session plan. Follow the flow steps in order.",
            "description": "Contains your step-by-step session structure",
            "usage": "reviewFirst tells you what to recall/review. newMaterial tells you what to introduce. flow gives you the session arc. principles are your guardrails."
          },
          "identity": {
            "priority": "HIGH - This is WHO you are",
            "description": "Your role, teaching techniques, boundaries, and style",
            "usage": "Use techniques when appropriate. Follow boundaries strictly. Let role guide your voice."
          },
          "content": {
            "priority": "HIGH - This is WHAT you teach",
            "description": "Curriculum modules in learning sequence",
            "usage": "Modules are ordered by prerequisites. Stay within current/next module. Don't skip ahead."
          },
          "behaviorTargets": {
            "priority": "MEDIUM - This is HOW you communicate",
            "description": "Style targets with when_high/when_low interpretations",
            "usage": "For HIGH targets, follow when_high guidance. For LOW, follow when_low. For MODERATE, blend both."
          },
          "personality": {
            "priority": "MEDIUM - Adapt to this caller",
            "description": "Big Five traits if measured",
            "usage": "High extraversion = more energy. Low openness = stay practical. High neuroticism = more reassurance."
          },
          "memories": {
            "priority": "MEDIUM - Reference naturally",
            "description": "Facts, preferences, topics from previous calls",
            "usage": "Weave into conversation naturally. Don't force. Shows you remember them."
          },
          "curriculum": {
            "priority": "MEDIUM - Track progress",
            "description": "Completed modules and next module to learn",
            "usage": "Know where they are. nextModule is your target. Don't repeat completed content unless reviewing."
          }
        },
        "executionRules": [
          "START with session_pedagogy.flow - it's your roadmap",
          "If sessionType is RETURNING_CALLER, ALWAYS do reviewFirst before newMaterial",
          "If sessionType is FIRST_CALL, welcome warmly and probe their existing knowledge",
          "Apply behaviorTargets throughout - they shape your communication style",
          "Reference memories when natural - don't force them",
          "Stay within identity.boundaries - never violate these",
          "End at a natural stopping point, not mid-concept"
        ],
        "adaptationRules": {
          "whenReviewFails": "If caller can't recall review material, don't proceed to new. Re-teach the foundation.",
          "whenCallerStruggles": "Back up one step. Use a different example. Don't push forward.",
          "whenCallerExcels": "Acknowledge briefly, then challenge with a harder application or critique.",
          "whenCallerWantsToSkip": "Only skip review if they PROVE they know it with a quick check."
        }
      }
    },
    {
      "id": "personality_section",
      "name": "Personality Context Section",
      "description": "Assembles personality-based communication guidance from ADAPT-PERS computations",
      "section": "composition",
      "config": {
        "thresholds": {
          "high": 0.65,
          "low": 0.35
        },
        "includePersonality": true
      },
      "interpretationScale": [
        {
          "min": 0.8,
          "max": 1.0,
          "label": "Complete",
          "implication": "All personality guidance included"
        },
        {
          "min": 0.5,
          "max": 0.8,
          "label": "Partial",
          "implication": "Some personality guidance included"
        },
        {
          "min": 0.0,
          "max": 0.5,
          "label": "Minimal",
          "implication": "Limited personality context"
        }
      ],
      "promptGuidance": {
        "whenHigh": "Full personality adaptation guidance provided.",
        "whenLow": "May need more personality measurements before full adaptation."
      }
    },
    {
      "id": "memory_section",
      "name": "Memory Context Section",
      "description": "Assembles relevant caller memories organized by category",
      "section": "composition",
      "config": {
        "memoriesLimit": 50,
        "memoriesPerCategory": 5,
        "includeMemories": true
      },
      "interpretationScale": [
        {
          "min": 0.8,
          "max": 1.0,
          "label": "Rich Context",
          "implication": "Comprehensive memory context assembled"
        },
        {
          "min": 0.5,
          "max": 0.8,
          "label": "Good Context",
          "implication": "Key memories included"
        },
        {
          "min": 0.0,
          "max": 0.5,
          "label": "Limited Context",
          "implication": "Few memories available"
        }
      ],
      "promptGuidance": {
        "whenHigh": "Rich memory context for personalized conversation.",
        "whenLow": "Limited history - focus on building new understanding."
      }
    },
    {
      "id": "behavior_targets_section",
      "name": "Behavior Targets Section",
      "description": "Assembles computed behavioral targets from ADAPT specs",
      "section": "composition",
      "config": {
        "includeBehaviorTargets": true
      },
      "interpretationScale": [
        {
          "min": 0.8,
          "max": 1.0,
          "label": "Full Targets",
          "implication": "Complete behavioral guidance"
        },
        {
          "min": 0.5,
          "max": 0.8,
          "label": "Partial Targets",
          "implication": "Some targets available"
        },
        {
          "min": 0.0,
          "max": 0.5,
          "label": "Default Targets",
          "implication": "Using system defaults"
        }
      ],
      "promptGuidance": {
        "whenHigh": "Personalized behavioral targets computed.",
        "whenLow": "Using general defaults - will personalize over time."
      }
    },
    {
      "id": "session_context_section",
      "name": "Session Context Section",
      "description": "Assembles session goals and continuity context",
      "section": "composition",
      "config": {
        "includeRecentCalls": true,
        "recentCallsLimit": 5
      },
      "interpretationScale": [
        {
          "min": 0.8,
          "max": 1.0,
          "label": "Full Context",
          "implication": "Complete session planning context"
        },
        {
          "min": 0.5,
          "max": 0.8,
          "label": "Good Context",
          "implication": "Key session context included"
        },
        {
          "min": 0.0,
          "max": 0.5,
          "label": "Minimal Context",
          "implication": "Limited session continuity"
        }
      ],
      "promptGuidance": {
        "whenHigh": "Clear session goals and continuity established.",
        "whenLow": "May need to establish context at start of call."
      }
    },
    {
      "id": "recent_history_section",
      "name": "Recent History Section",
      "description": "Assembles summaries of recent calls for continuity",
      "section": "composition",
      "config": {
        "maxTokens": 1500,
        "temperature": 0.7
      },
      "interpretationScale": [
        {
          "min": 0.8,
          "max": 1.0,
          "label": "Full History",
          "implication": "Recent calls well-documented"
        },
        {
          "min": 0.5,
          "max": 0.8,
          "label": "Some History",
          "implication": "Key recent calls included"
        },
        {
          "min": 0.0,
          "max": 0.5,
          "label": "New Caller",
          "implication": "Limited or no call history"
        }
      ],
      "promptGuidance": {
        "whenHigh": "Rich history for conversation continuity.",
        "whenLow": "New relationship - focus on discovery."
      }
    },
    {
      "id": "curriculum_section",
      "name": "Curriculum Progress Section",
      "description": "Assembles curriculum tracking data including current module, mastery level, and next content to learn",
      "section": "composition",
      "config": {
        "includeCurriculum": true
      },
      "interpretationScale": [
        {
          "min": 0.8,
          "max": 1.0,
          "label": "Full Curriculum",
          "implication": "Complete curriculum context with clear next steps"
        },
        {
          "min": 0.5,
          "max": 0.8,
          "label": "Partial Curriculum",
          "implication": "Some curriculum data available"
        },
        {
          "min": 0.0,
          "max": 0.5,
          "label": "No Curriculum",
          "implication": "No curriculum tracking data yet"
        }
      ],
      "promptGuidance": {
        "whenHigh": "Clear curriculum path - guide learner through next content.",
        "whenLow": "No curriculum data - assess level and establish starting point."
      }
    },
    {
      "id": "learner_goals_section",
      "name": "Learner Goals Section",
      "description": "Assembles learner's active goals and session objectives from GOAL-001 data",
      "section": "composition",
      "config": {
        "includeLearnerGoals": true
      },
      "interpretationScale": [
        {
          "min": 0.8,
          "max": 1.0,
          "label": "Clear Goals",
          "implication": "Well-defined learner goals available"
        },
        {
          "min": 0.5,
          "max": 0.8,
          "label": "Some Goals",
          "implication": "Partial goal information"
        },
        {
          "min": 0.0,
          "max": 0.5,
          "label": "No Goals",
          "implication": "Learner goals not yet defined"
        }
      ],
      "promptGuidance": {
        "whenHigh": "Work toward stated learner goals in this session.",
        "whenLow": "Explore learner interests and collaboratively set goals."
      }
    },
    {
      "id": "domain_context_section",
      "name": "Domain Context Section",
      "description": "Assembles domain-specific attributes and context for the caller's assigned domain",
      "section": "composition",
      "config": {
        "includeSessionPlanning": true
      },
      "interpretationScale": [
        {
          "min": 0.8,
          "max": 1.0,
          "label": "Rich Domain",
          "implication": "Full domain-specific context available"
        },
        {
          "min": 0.5,
          "max": 0.8,
          "label": "Basic Domain",
          "implication": "Domain assigned with some context"
        },
        {
          "min": 0.0,
          "max": 0.5,
          "label": "No Domain",
          "implication": "Caller not assigned to a domain"
        }
      ],
      "promptGuidance": {
        "whenHigh": "Apply domain-specific guidance and content.",
        "whenLow": "Use general approach until domain is established."
      }
    }
  ],
  "sections": [
    {
      "id": "caller_info",
      "name": "Caller Information",
      "priority": 1,
      "dataSource": "caller",
      "activateWhen": {
        "condition": "always"
      },
      "fallback": {
        "action": "omit"
      },
      "transform": null,
      "outputKey": "caller"
    },
    {
      "id": "personality",
      "name": "Personality Profile",
      "priority": 2,
      "dataSource": "personality",
      "activateWhen": {
        "condition": "dataExists"
      },
      "fallback": {
        "action": "null"
      },
      "transform": "mapPersonalityTraits",
      "outputKey": "personality"
    },
    {
      "id": "learner_profile",
      "name": "Learner Profile",
      "priority": 3,
      "dataSource": "learnerProfile",
      "activateWhen": {
        "condition": "dataExists"
      },
      "fallback": {
        "action": "null"
      },
      "transform": "mapLearnerProfile",
      "outputKey": "learnerProfile"
    },
    {
      "id": "memories",
      "name": "Caller Memories",
      "priority": 4,
      "dataSource": "memories",
      "activateWhen": {
        "condition": "dataExists"
      },
      "fallback": {
        "action": "emptyObject",
        "value": {
          "totalCount": 0,
          "byCategory": {},
          "all": []
        }
      },
      "transform": "deduplicateAndGroupMemories",
      "config": {
        "memoriesPerCategory": 5
      },
      "outputKey": "memories"
    },
    {
      "id": "behavior_targets",
      "name": "Behavior Targets",
      "priority": 5,
      "dataSource": [
        "behaviorTargets",
        "callerTargets"
      ],
      "activateWhen": {
        "condition": "always"
      },
      "fallback": {
        "action": "emptyObject",
        "value": {
          "totalCount": 0,
          "byDomain": {},
          "all": []
        }
      },
      "transform": "mergeAndGroupTargets",
      "outputKey": "behaviorTargets"
    },
    {
      "id": "call_history",
      "name": "Call History",
      "priority": 6,
      "dataSource": [
        "recentCalls",
        "callCount"
      ],
      "activateWhen": {
        "condition": "always"
      },
      "fallback": {
        "action": "emptyObject",
        "value": {
          "totalCalls": 0,
          "mostRecent": null,
          "recent": []
        }
      },
      "transform": "computeCallHistory",
      "outputKey": "callHistory"
    },
    {
      "id": "curriculum",
      "name": "Curriculum Progress",
      "priority": 7,
      "dataSource": "_assembled",
      "activateWhen": {
        "condition": "contentSpecExists"
      },
      "fallback": {
        "action": "null"
      },
      "transform": "computeModuleProgress",
      "outputKey": "curriculum"
    },
    {
      "id": "session_planning",
      "name": "Session Planning",
      "priority": 8,
      "dataSource": "callerAttributes",
      "activateWhen": {
        "condition": "dataExists"
      },
      "fallback": {
        "action": "emptyObject",
        "value": {
          "hasData": false,
          "context": []
        }
      },
      "transform": "filterSessionAttributes",
      "outputKey": "sessionPlanning"
    },
    {
      "id": "learner_goals",
      "name": "Learner Goals",
      "priority": 9,
      "dataSource": "goals",
      "activateWhen": {
        "condition": "dataExists"
      },
      "fallback": {
        "action": "emptyObject",
        "value": {
          "hasData": false,
          "goals": []
        }
      },
      "transform": "mapGoals",
      "outputKey": "learnerGoals"
    },
    {
      "id": "domain_context",
      "name": "Domain Context",
      "priority": 10,
      "dataSource": [
        "callerDomain",
        "callerAttributes"
      ],
      "activateWhen": {
        "condition": "callerHasDomain"
      },
      "fallback": {
        "action": "null"
      },
      "transform": "computeDomainContext",
      "outputKey": "domain"
    },
    {
      "id": "identity",
      "name": "Agent Identity",
      "priority": 11,
      "dataSource": "_assembled",
      "activateWhen": {
        "condition": "always"
      },
      "fallback": {
        "action": "null"
      },
      "transform": "extractIdentitySpec",
      "outputKey": "identity"
    },
    {
      "id": "content",
      "name": "Content Spec",
      "priority": 12,
      "dataSource": "_assembled",
      "activateWhen": {
        "condition": "contentSpecExists"
      },
      "fallback": {
        "action": "null"
      },
      "transform": "extractContentSpec",
      "outputKey": "content"
    },
    {
      "id": "instructions_pedagogy",
      "name": "Session Pedagogy",
      "priority": 13,
      "dataSource": "_assembled",
      "activateWhen": {
        "condition": "always"
      },
      "fallback": {
        "action": "null"
      },
      "transform": "computeSessionPedagogy",
      "outputKey": "instructions_pedagogy",
      "dependsOn": [
        "curriculum"
      ]
    },
    {
      "id": "instructions_voice",
      "name": "Voice Guidance",
      "priority": 14,
      "dataSource": "_assembled",
      "activateWhen": {
        "condition": "always"
      },
      "fallback": {
        "action": "null"
      },
      "transform": "computeVoiceGuidance",
      "outputKey": "instructions_voice"
    },
    {
      "id": "instructions",
      "name": "Instructions",
      "priority": 15,
      "dataSource": "_assembled",
      "activateWhen": {
        "condition": "always"
      },
      "fallback": {
        "action": "emptyObject"
      },
      "transform": "computeInstructions",
      "outputKey": "instructions",
      "dependsOn": [
        "memories",
        "personality",
        "behavior_targets",
        "curriculum",
        "learner_goals",
        "identity",
        "content",
        "instructions_pedagogy",
        "instructions_voice"
      ]
    },
    {
      "id": "quick_start",
      "name": "Quick Start",
      "priority": 0,
      "dataSource": "_assembled",
      "activateWhen": {
        "condition": "always"
      },
      "fallback": {
        "action": "emptyObject"
      },
      "transform": "computeQuickStart",
      "outputKey": "_quickStart",
      "dependsOn": [
        "caller_info",
        "memories",
        "behavior_targets",
        "curriculum",
        "learner_goals",
        "identity"
      ]
    },
    {
      "id": "preamble",
      "name": "Preamble",
      "priority": -1,
      "dataSource": "_assembled",
      "activateWhen": {
        "condition": "always"
      },
      "fallback": {
        "action": "emptyObject"
      },
      "transform": "computePreamble",
      "outputKey": "_preamble",
      "dependsOn": [
        "identity"
      ]
    },
    {
      "id": "first_call_bootstrap",
      "name": "First Call Bootstrap",
      "priority": 0,
      "dataSource": "_assembled",
      "activateWhen": {
        "condition": "callCount == 0"
      },
      "fallback": {
        "action": "skip"
      },
      "transform": null,
      "outputKey": "_firstCallBootstrap",
      "dependsOn": [
        "quick_start",
        "instructions"
      ]
    }
  ],
  "constraints": [
    {
      "id": "C-COMP-1",
      "type": "length",
      "description": "Composed prompt should stay within token limits for efficiency",
      "severity": "warning"
    },
    {
      "id": "C-COMP-2",
      "type": "relevance",
      "description": "Include only contextually relevant information",
      "severity": "info"
    },
    {
      "id": "C-COMP-3",
      "type": "ordering",
      "description": "Most important context should appear first",
      "severity": "info"
    }
  ],
  "related": [
    {
      "id": "PERS-001",
      "title": "Personality Measurement",
      "relationship": "provides personality input"
    },
    {
      "id": "MEM-001",
      "title": "Memory Extraction",
      "relationship": "provides memory input"
    },
    {
      "id": "ADAPT-PERS-001",
      "title": "Personality Adaptation",
      "relationship": "provides style targets"
    },
    {
      "id": "SESSION-001",
      "title": "Session Planning",
      "relationship": "provides session context"
    },
    {
      "id": "CURR-001",
      "title": "Curriculum Tracking",
      "relationship": "provides curriculum progress and next content"
    },
    {
      "id": "GOAL-001",
      "title": "Learner Goals",
      "relationship": "provides learning objectives and session goals"
    }
  ],
  "specRole": "SYNTHESISE"
}
