# HF Internal API Reference

> Auto-generated from `@api` JSDoc annotations in route.ts files.
>
> **Last generated**: 2026-02-15

<!-- DO NOT EDIT DIRECTLY -->
<!-- This file is auto-generated by scripts/api-docs/generator.ts -->
<!-- To update: modify @api annotations in route.ts files, then run: -->
<!--   npx tsx scripts/api-docs/generator.ts -->

> **Do not edit this file directly.** Update the `@api` JSDoc annotations
> in the corresponding `route.ts` files, then regenerate:
> ```bash
> npx tsx scripts/api-docs/generator.ts
> ```

---

## Table of Contents

- [Endpoints](#endpoints)
  - [Account](#account)
  - [Admin](#admin)
  - [Agents](#agents)
  - [AI](#ai)
  - [Analysis](#analysis)
  - [Analysis Specs](#analysis-specs)
  - [Analytics](#analytics)
  - [Auth](#auth)
  - [Callers](#callers)
  - [Calls](#calls)
  - [Chat](#chat)
  - [Cohorts](#cohorts)
  - [Content Sources](#content-sources)
  - [Content Trust](#content-trust)
  - [Data Dictionary](#data-dictionary)
  - [Dev Tools](#dev-tools)
  - [Domains](#domains)
  - [Educator](#educator)
  - [Goals](#goals)
  - [Invites](#invites)
  - [Lab](#lab)
  - [Layers](#layers)
  - [Logs](#logs)
  - [Manifest](#manifest)
  - [Memories](#memories)
  - [Messages](#messages)
  - [Metering](#metering)
  - [Onboarding](#onboarding)
  - [Ops](#ops)
  - [Other](#other)
  - [Parameters](#parameters)
  - [Pipeline](#pipeline)
  - [Playbooks](#playbooks)
  - [Prompts](#prompts)
  - [Settings](#settings)
  - [Sidebar](#sidebar)
  - [Sim](#sim)
  - [Specs](#specs)
  - [Subjects](#subjects)
  - [System](#system)
  - [Tasks](#tasks)
  - [Test Harness](#test-harness)
  - [Tickets](#tickets)
  - [Transcripts](#transcripts)
  - [Users](#users)
  - [Vapi](#vapi)
  - [Visualizations](#visualizations)
  - [Workflow](#workflow)
- [Architecture Notes](#architecture-notes)
- [Environment Variables](#environment-variables)
- [Coverage](#coverage)

---

## Endpoints

## Account

### `GET` /api/account

Get the authenticated user's own profile

**Auth**: Session · **Scope**: `account:read`

**Response** `200`
```json
{ ok: true, user: object }
```

---

### `PATCH` /api/account

Update the authenticated user's own display name and name

**Auth**: Session · **Scope**: `account:write`

**Response** `200`
```json
{ ok: true, user: object }
```

---

## Admin

### `GET` /api/admin/access-matrix

Load the ENTITY_ACCESS_V1 contract for the access matrix viewer

**Auth**: Session · **Scope**: `admin:read`

**Response** `200`
```json
{ ok: true, contract: object }
```

**Response** `404`
```json
{ ok: false, error: "Contract not found" }
```

---

### `GET` /api/admin/app-config

Returns the active base URL and its source env var.

**Auth**: Session · **Scope**: `admin:read`

**Response** `200`
```json
{ baseUrl: string, source: "NEXT_PUBLIC_APP_URL" | "NEXTAUTH_URL" | "default" }
```

---

### `GET` /api/admin/audit

Get audit logging status and recent audit log entries

**Auth**: Bearer token · **Scope**: `admin:read`

**Response** `200`
```json
{ enabled: boolean, logs: AuditLog[] }
```

**Response** `401`
```json
{ error: "Unauthorized" }
```

**Response** `500`
```json
{ error: "Failed to get audit status" }
```

---

### `POST` /api/admin/audit

Toggle audit logging on or off (ADMIN role required)

**Auth**: Bearer token · **Scope**: `admin:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| enabled | body | boolean | No | Whether audit logging should be enabled |

**Response** `200`
```json
{ enabled: boolean }
```

**Response** `400`
```json
{ error: "enabled must be a boolean" }
```

**Response** `401`
```json
{ error: "Unauthorized" }
```

**Response** `403`
```json
{ error: "Forbidden - Admin only" }
```

**Response** `500`
```json
{ error: "Failed to update audit setting" }
```

---

### `DELETE` /api/admin/masquerade

Stop stepping in — clears masquerade cookie and audit-logs the exit.

**Auth**: Bearer token · **Scope**: `admin:write`

---

### `GET` /api/admin/masquerade

Get current masquerade state (or null if not masquerading)

**Auth**: Bearer token · **Scope**: `admin:read`

---

### `POST` /api/admin/masquerade

Start stepping in as another user. Validates target exists, is active, and role is not escalated.

**Auth**: Bearer token · **Scope**: `admin:write`

---

### `GET` /api/admin/masquerade/users

List users available to step in as (excludes current user, active only, max 50)

**Auth**: Bearer token · **Scope**: `admin:read`

---

### `GET` /api/admin/registry

View all canonical parameters with coverage stats

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| deprecated | query | boolean | No | Show deprecated parameters (default: false) |
| orphaned | query | boolean | No | Show only orphaned parameters with no spec actions (default: false) |

**Response** `200`
```json
{ ok: true, parameters: Array<{ id, parameterId, name, definition, domainGroup, defaultTarget, isCanonical, deprecatedAt, replacedBy, aliases, usage: { inActions, inTargets, inScores, total } }>, summary: { total, active, deprecated, inUse, orphaned, byDomain } }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `PUT` /api/admin/registry

Update a parameter's registry fields (name, definition, deprecated, etc.)

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| parameterId | body | string | No | The parameter ID to update (required) |
| name | body | string | No | New display name |
| definition | body | string | No | New definition text |
| defaultTarget | body | number | No | New default target value |
| deprecatedAt | body | string | No | ISO date to mark as deprecated, or null to unmark |
| replacedBy | body | string | No | Replacement parameter ID if deprecated |
| isCanonical | body | boolean | No | Whether this is the canonical version |

**Response** `200`
```json
{ ok: true, parameter: Parameter, message: string }
```

**Response** `400`
```json
{ ok: false, error: "parameterId is required" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `POST` /api/admin/retention/cleanup

Process data retention cleanup. Deletes expired caller data

**Auth**: Session · **Scope**: `admin:write`

---

### `DELETE` /api/admin/sidebar-layout

Clear the global default sidebar layout (ADMIN role required)

**Auth**: Bearer token · **Scope**: `admin:write`

**Response** `200`
```json
{ success: true }
```

**Response** `401`
```json
{ error: "Unauthorized" }
```

**Response** `403`
```json
{ error: "Forbidden" }
```

---

### `GET` /api/admin/sidebar-layout

Get the global default sidebar layout from system settings

**Auth**: Bearer token · **Scope**: `admin:read`

**Response** `200`
```json
{ layout: SidebarLayout | null }
```

---

### `POST` /api/admin/sidebar-layout

Set the global default sidebar layout (ADMIN role required)

**Auth**: Bearer token · **Scope**: `admin:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| layout | body | SidebarLayout | No | The sidebar layout configuration with sectionOrder array |

**Response** `200`
```json
{ success: true }
```

**Response** `400`
```json
{ error: "Invalid layout format" }
```

**Response** `401`
```json
{ error: "Unauthorized" }
```

**Response** `403`
```json
{ error: "Forbidden" }
```

**Response** `500`
```json
{ error: "Failed to save layout" }
```

---

### `GET` /api/admin/spec-sync

Compare docs-archive/bdd-specs/*.spec.json files with database AnalysisSpec records. Returns which specs are synced, unseeded, or orphaned.

**Auth**: Session

**Response** `200`
```json
{ ok: true, summary: { totalFiles, synced, unseeded, orphaned }, synced: Array, unseeded: Array, orphaned: Array }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `POST` /api/admin/spec-sync

Import all unseeded specs from docs-archive/bdd-specs/ folder into the database

**Auth**: Session

**Response** `200`
```json
{ ok: true, message: string, summary: { specsProcessed, parametersCreated, parametersUpdated, anchorsCreated, specsCreated }, results: Array }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/admin/sync-parameters

Dry-run check for missing parameters - reports what would be fixed without making changes

**Auth**: Session

**Response** `200`
```json
{ ok: true, specsScanned: number, parametersReferenced: number, parametersExist: number, parametersMissing: number, missingParameters: Array }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `POST` /api/admin/sync-parameters

Detect and create missing parameters referenced by spec triggers/actions

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| dryRun | body | boolean | No | If true, only report without making changes (default: false) |

**Response** `200`
```json
{ ok: true, specsScanned: number, parametersReferenced: number, parametersExist: number, parametersMissing: number, parametersCreated: number, errors: string[], missingParameters: Array }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/admin/tests/list

List all Playwright E2E tests grouped by file

**Auth**: Bearer token · **Scope**: `admin:read`

**Response** `200`
```json
{ ok: true, totalTests: number, files: number, tests: Test[], grouped: Record<string, Test[]> }
```

**Response** `500`
```json
{ ok: false, error: "...", stderr: "..." }
```

---

### `GET` /api/admin/tests/report

Get the latest Playwright test report data including summary stats

**Auth**: Bearer token · **Scope**: `admin:read`

**Response** `200`
```json
{ ok: true, hasReport: true, hasHtmlReport: boolean, summary: { total, passed, failed, skipped, duration } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/admin/tests/report/html

Serve Playwright HTML report files with appropriate content types

**Auth**: Bearer token · **Scope**: `admin:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| file | query | string | No | Relative file path within the report directory (default: "index.html") |

**Response** `200`
```json
File content with appropriate Content-Type header
```

**Response** `400`
```json
{ error: "Invalid file path" }
```

**Response** `404`
```json
{ error: "File not found" }
```

**Response** `500`
```json
{ error: "..." }
```

---

### `GET` /api/admin/tests/run

Get status of a specific test run by ID, or list all runs if no runId provided

**Auth**: Bearer token · **Scope**: `admin:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| runId | query | string | No | Optional run ID to get status for |

**Response** `200`
```json
{ ok: true, runId: string, status: string, output: string, ... }
```

**Response** `404`
```json
{ ok: false, error: "Run not found" }
```

---

### `POST` /api/admin/tests/run

Start a Playwright test run with optional file, project, and test name filters

**Auth**: Bearer token · **Scope**: `admin:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| file | body | string | No | Optional test file to run |
| project | body | string | No | Optional Playwright project name |
| testName | body | string | No | Optional test name filter (grep) |

**Response** `200`
```json
{ ok: true, runId: string, message: "Test run started", command: string }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/admin/users

Delete a user and all related records (ADMIN role required, cannot delete self)

**Auth**: Bearer token · **Scope**: `admin:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | query | string | No | User ID to delete |

**Response** `200`
```json
{ ok: true }
```

**Response** `400`
```json
{ error: "User ID required" }
```

**Response** `400`
```json
{ error: "Cannot delete your own account" }
```

**Response** `401`
```json
{ error: "Unauthorized" }
```

**Response** `403`
```json
{ error: "Forbidden" }
```

---

### `GET` /api/admin/users

List all admin users with basic profile information (ADMIN role required)

**Auth**: Bearer token · **Scope**: `admin:read`

**Response** `200`
```json
{ users: User[] }
```

**Response** `401`
```json
{ error: "Unauthorized" }
```

**Response** `403`
```json
{ error: "Forbidden" }
```

---

### `PATCH` /api/admin/users

Update a user's role or active status (ADMIN role required, cannot deactivate self)

**Auth**: Bearer token · **Scope**: `admin:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | body | string | No | User ID to update |
| role | body | string | No | New role value |
| isActive | body | boolean | No | Whether user is active |

**Response** `200`
```json
{ user: User }
```

**Response** `400`
```json
{ error: "User ID required" }
```

**Response** `400`
```json
{ error: "Cannot deactivate your own account" }
```

**Response** `401`
```json
{ error: "Unauthorized" }
```

**Response** `403`
```json
{ error: "Forbidden" }
```

---

## Agents

### `GET` /api/agents

List all agents from manifest with overrides, DB instances, and resolved settings

**Auth**: Session · **Scope**: `agents:read`

**Response** `200`
```json
{ ok: true, agents: AgentConfig[], resolved: { env, kbRoot, layout, ... } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/agents

Save agent configuration overrides (enabled state and settings) to the KB store

**Auth**: Session · **Scope**: `agents:write`

**Response** `200`
```json
{ ok: true, agents: AgentConfig[], resolved: { kbRoot, layout, storePath, ... } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/agents/:agentId

Archive an agent instance by version (soft delete, cannot archive PUBLISHED instances)

**Auth**: Session · **Scope**: `agents:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| agentId | path | string | Yes | The agent identifier |
| version | query | string | No | The version to archive (required) |

**Response** `200`
```json
{ ok: true, action: "archived", instance: AgentInstance }
```

**Response** `400`
```json
{ ok: false, error: "version query param required" }
```

**Response** `400`
```json
{ ok: false, error: "Cannot archive published instance - supersede it first" }
```

**Response** `404`
```json
{ ok: false, error: "Instance not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/agents/:agentId

Get agent details including published, draft, and history versions with path resolution info

**Auth**: Session · **Scope**: `agents:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| agentId | path | string | Yes | The agent identifier |

**Response** `200`
```json
{ ok: true, agentId, published, draft, history, allVersions, paths }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PUT` /api/agents/:agentId

Create or update a draft agent instance with name, description, and settings

**Auth**: Session · **Scope**: `agents:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| agentId | path | string | Yes | The agent identifier |
| name | body | string | No | Agent instance name |
| description | body | string | No | Agent instance description |
| settings | body | object | No | Agent settings configuration |

**Response** `200`
```json
{ ok: true, action: "created"|"updated", instance: AgentInstance }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/agents/:agentId/preflight

Check if all prerequisites are met for running an agent (DB table counts, file paths)

**Auth**: Session · **Scope**: `agents:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| agentId | path | string | Yes | The agent identifier |

**Response** `200`
```json
{ ok: true, canRun: boolean, hasWarnings: boolean, checks: PrerequisiteResult[], summary: { passed, failed, warnings } }
```

**Response** `404`
```json
{ ok: false, error: "Agent not found: ..." }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/agents/:agentId/publish

Get the currently published instance for this agent with recent runs

**Auth**: Session · **Scope**: `agents:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| agentId | path | string | Yes | The agent identifier |

**Response** `200`
```json
{ ok: true, published: AgentInstance | null }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/agents/:agentId/publish

Publish the current draft agent instance, superseding any existing published version.

**Auth**: Session · **Scope**: `agents:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| agentId | path | string | Yes | The agent identifier |

**Response** `200`
```json
{ ok: true, action: "published", instance: AgentInstance, superseded: { id, version } | null }
```

**Response** `404`
```json
{ ok: false, error: "No draft found to publish" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/agents/by-data-node

Find agents connected to a specific data node (as consumer, producer, or both) with recent run status

**Auth**: Session · **Scope**: `agents:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| dataNode | query | string | No | The data node identifier (e.g. "data:knowledge") |

**Response** `200`
```json
{ ok: true, dataNode: string, agents: AgentInfo[] }
```

**Response** `400`
```json
{ ok: false, error: "dataNode query parameter is required" }
```

**Response** `404`
```json
{ ok: false, error: "Agents manifest not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/agents/run

Get agent run API info and metadata (kbRoot, runsFile path)

**Auth**: Session · **Scope**: `agents:read`

**Response** `200`
```json
{ ok: true, note: string, meta: { kbRoot, runsFile } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/agents/run

Execute an agent by resolving its agentId to an Ops opid, running the op, and persisting the run record

**Auth**: Session · **Scope**: `agents:execute`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| agentId | body | string | No | Agent identifier to run |
| dryRun | body | boolean | No | If true, do not actually execute (default: false) |
| settings | body | object | No | Optional settings overrides |

**Response** `200`
```json
{ ok: true, run: AgentRun, ops: OpsResult, meta: { runsFile, usedPublishedInstance, ... } }
```

**Response** `400`
```json
{ ok: false, error: "Unknown agentId: ..." }
```

**Response** `400`
```json
{ ok: false, error: "Invalid JSON body" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/agents/runs

List agent runs with optional filters for agentId, status, and limit

**Auth**: Session · **Scope**: `agents:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| agentId | query | string | No | Filter by agent ID |
| status | query | string | No | Comma-separated status filter (QUEUED, RUNNING, OK, ERROR) |
| limit | query | number | No | Max results (1-500, default: 50) |

**Response** `200`
```json
{ ok: true, agentId, status, limit, count, runs: AgentRun[] }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## AI

### `DELETE` /api/ai-config

Remove a custom AI configuration for a call point, reverting it to default settings.

**Auth**: Session · **Scope**: `ai-config:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callPoint | query | string | No | The call point to revert (required) |

**Response** `200`
```json
{ ok: true, message: "Reverted ... to default settings" }
```

**Response** `400`
```json
{ ok: false, error: "callPoint query parameter is required" }
```

**Response** `404`
```json
{ ok: false, error: "No custom config found for ..." }
```

**Response** `500`
```json
{ ok: false, error: "Failed to delete AI configuration" }
```

---

### `GET` /api/ai-config

List all AI call-point configurations, merged with defaults for unconfigured points. Returns available models and API key status per provider.

**Auth**: Session · **Scope**: `ai-config:read`

**Response** `200`
```json
{ ok: true, configs: [...], availableModels: {...}, callPoints: [...], keyStatus: {...} }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch AI configurations" }
```

---

### `POST` /api/ai-config

Create or update an AI configuration for a specific call point. Validates provider, model, and call point before upserting.

**Auth**: Session · **Scope**: `ai-config:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callPoint | body | string | No | The call point identifier (e.g. "pipeline.measure") |
| provider | body | string | No | AI provider ("claude" | "openai" | "mock") |
| model | body | string | No | Model identifier (must exist for the chosen provider) |
| isActive | body | boolean | No | Whether this config is active (default true) |

**Response** `200`
```json
{ ok: true, config: {...}, message: "Updated AI config for ..." }
```

**Response** `400`
```json
{ ok: false, error: "Invalid callPoint: ..." }
```

**Response** `500`
```json
{ ok: false, error: "Failed to update AI configuration" }
```

---

### `DELETE` /api/ai-keys

Remove an API key for a provider from the .env.local file. Requires server restart to take effect.

**Auth**: Bearer token · **Scope**: `ai-keys:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| provider | query | string | No | AI provider name (e.g. "claude", "openai") |

**Response** `200`
```json
{ ok: true, message: "Removed ... from .env. Restart the server to apply." }
```

**Response** `400`
```json
{ ok: false, error: "Provider is required" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to delete API key" }
```

---

### `GET` /api/ai-keys

Return API key status for all configured AI providers. Keys are masked for display; shows whether each key comes from .env file or runtime environment.

**Auth**: Session · **Scope**: `ai-keys:read`

**Response** `200`
```json
{ ok: true, keys: { claude: { envVar, configured, masked, fromEnv }, ... }, envPath: "..." }
```

---

### `POST` /api/ai-keys

Save an API key for a provider to the .env.local file. Requires server restart to take effect.

**Auth**: Bearer token · **Scope**: `ai-keys:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| provider | body | string | No | AI provider name (e.g. "claude", "openai") |
| key | body | string | No | The API key value |

**Response** `200`
```json
{ ok: true, message: "Saved ... to .env. Restart the server to apply.", envVar: "...", masked: "..." }
```

**Response** `400`
```json
{ ok: false, error: "Provider and key are required" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to save API key" }
```

---

### `POST` /api/ai-keys/test

Test an API key against a provider by making a lightweight validation call. If no key is provided, tests the currently configured runtime key.

**Auth**: Session · **Scope**: `ai-keys:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| provider | body | string | No | AI provider to test ("claude" | "openai" | "mock") |
| key | body | string | No | Optional API key to test; uses runtime env var if omitted |

**Response** `200`
```json
{ ok: true, valid: true, message: "Key is valid", model?: "..." }
```

**Response** `200`
```json
{ ok: true, valid: false, message: "Invalid API key" }
```

**Response** `400`
```json
{ ok: false, error: "Provider is required" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to test API key" }
```

---

### `GET` /api/ai-models

List all available AI models, optionally filtered by provider. Seeds default models on first access if the table is empty. Returns models grouped by provider for UI consumption.

**Auth**: Session · **Scope**: `ai-models:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| provider | query | string | No | Filter by provider (optional) |
| includeInactive | query | string | No | Include inactive models ("true" to include, default: false) |

**Response** `200`
```json
{ ok: true, models: [...], byProvider: {...}, providers: [...] }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch models" }
```

---

### `POST` /api/ai-models

Create a new AI model record. Validates provider and tier, and checks for duplicate modelId before inserting.

**Auth**: Bearer token · **Scope**: `ai-models:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| modelId | body | string | No | Unique model identifier (e.g. "gpt-4o") |
| provider | body | string | No | Provider name ("claude" | "openai" | "mock") |
| label | body | string | No | Human-readable model label |
| tier | body | string | No | Model tier ("flagship" | "standard" | "fast" | "test"), default "standard" |
| sortOrder | body | number | No | Display sort order (default 99) |
| isActive | body | boolean | No | Whether the model is active (default true) |

**Response** `200`
```json
{ ok: true, model: {...} }
```

**Response** `400`
```json
{ ok: false, error: "modelId, provider, and label are required" }
```

**Response** `409`
```json
{ ok: false, error: "Model with ID \"...\" already exists" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to create model" }
```

---

### `DELETE` /api/ai-models/:modelId

Delete an AI model. Fails with 409 if the model is currently referenced by any AIConfig call point.

**Auth**: Bearer token · **Scope**: `ai-models:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| modelId | path | string | Yes | The unique model identifier |

**Response** `200`
```json
{ ok: true, message: "Model \"...\" deleted" }
```

**Response** `404`
```json
{ ok: false, error: "Model \"...\" not found" }
```

**Response** `409`
```json
{ ok: false, error: "Cannot delete model \"...\" - it is in use by call point \"...\"" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to delete model" }
```

---

### `GET` /api/ai-models/:modelId

Fetch a single AI model by its modelId.

**Auth**: Session · **Scope**: `ai-models:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| modelId | path | string | Yes | The unique model identifier |

**Response** `200`
```json
{ ok: true, model: {...} }
```

**Response** `404`
```json
{ ok: false, error: "Model \"...\" not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch model" }
```

---

### `PUT` /api/ai-models/:modelId

Update an existing AI model's properties (label, tier, sortOrder, isActive). Only provided fields are updated.

**Auth**: Bearer token · **Scope**: `ai-models:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| modelId | path | string | Yes | The unique model identifier |
| label | body | string | No | Updated display label (optional) |
| tier | body | string | No | Updated tier ("flagship" | "standard" | "fast" | "test") (optional) |
| sortOrder | body | number | No | Updated sort order (optional) |
| isActive | body | boolean | No | Updated active state (optional) |

**Response** `200`
```json
{ ok: true, model: {...} }
```

**Response** `400`
```json
{ ok: false, error: "Invalid tier. Must be one of: ..." }
```

**Response** `404`
```json
{ ok: false, error: "Model \"...\" not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to update model" }
```

---

### `POST` /api/ai/assistant

General-purpose AI assistant with full system awareness. Loads comprehensive system context (specs, parameters, domains, callers, etc.), injects location and entity context, and returns an AI-generated response. Logs all interactions for pattern learning.

**Auth**: Session · **Scope**: `ai-assistant:invoke`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| message | body | string | No | The user's message (required) |
| context | body | object | No | Optional viewing context { type: string, data: any } (e.g. caller, spec) |
| location | body | LocationContext | No | Optional current page/route context |
| mode | body | string | No | Chat mode: "chat" | "tasks" | "data" | "spec" (default "chat") |

**Response** `200`
```json
{ ok: true, response: "...", suggestions?: {...} }
```

**Response** `400`
```json
{ ok: false, error: "message is required" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to get AI response" }
```

---

### `GET` /api/ai/assistant/search

Search through previous AI assistant conversations by keyword

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| q | query | string | No | Search query (required) |
| callPoint | query | string | No | Filter by call point (e.g., "assistant.chat", "assistant.tasks") |
| limit | query | number | No | Max results (default: 20, max: 100) |
| offset | query | number | No | Pagination offset (default: 0) |

**Response** `200`
```json
{ ok: true, results: Array<{ id, callPoint, userMessage, aiResponse, outcome, metadata, timestamp }>, total: number, limit: number, offset: number, query: string }
```

**Response** `400`
```json
{ ok: false, error: "Search query is required" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/ai/errors

Get recent AI interaction failures and failure statistics for the error monitor dashboard

**Auth**: Session · **Scope**: `admin:read`

**Response** `200`
```json
{ ok: true, failures: Array, stats: object }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/ai/knowledge

Export AI learned knowledge (patterns, interaction stats) for the knowledge dashboard

**Auth**: Session

**Response** `200`
```json
{ ok: true, knowledge: object }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

## Analysis

### `POST` /api/analysis/run

Unified analysis endpoint that handles both MEASURE and LEARN specs. Analyzes a transcript using active analysis specs, scores behavioral parameters, extracts learned facts, and optionally stores results. Also calculates ADAPT scores (deltas/goal progress) when storing.

**Auth**: Session · **Scope**: `analysis:run`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| transcript | body | string | No | The transcript text to analyze (required) |
| callId | body | string | No | Call ID for storing results (optional) |
| callerId | body | string | No | Caller ID for storing memories (optional) |
| model | body | string | No | Claude model to use (default: claude-3-haiku-20240307) |
| storeResults | body | boolean | No | Whether to persist results to database (default: false) |

**Response** `200`
```json
{ ok: true, callId, callerId, model, analysisTime, usage: {...}, measures: {...}, learned: [...], stored: {...}, adapt: {...}, summary: {...} }
```

**Response** `400`
```json
{ ok: false, error: "transcript is required" }
```

**Response** `404`
```json
{ ok: false, error: "No active analysis specs found matching criteria" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Analysis Specs

### `GET` /api/analysis-specs

List analysis specifications with optional filtering, trigger/action counts, and playbook usage

**Auth**: Session · **Scope**: `analysis-specs:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| limit | query | number | No | Max records (default 100) |
| domain | query | string | No | Filter by domain (personality, memory, engagement, etc.) |
| outputType | query | string | No | Filter by output type (MEASURE, LEARN, etc.) |
| active | query | string | No | Filter by active status: "true", "false", or "all" (default "all") |
| include | query | string | No | Set to "full" to include triggers, actions, and parameter anchors |

**Response** `200`
```json
{ ok: true, specs: AnalysisSpec[], count: number }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/analysis-specs

Create a new analysis specification with nested triggers and actions. Validates parameter IDs for MEASURE specs.

**Auth**: Session · **Scope**: `analysis-specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| slug | body | string | No | Unique spec slug |
| name | body | string | No | Display name |
| description | body | string | No | Optional description |
| outputType | body | string | No | "MEASURE" or "LEARN" (default: "MEASURE") |
| domain | body | string | No | Domain category (personality, memory, engagement, etc.) |
| priority | body | number | No | Spec priority (default: 0) |
| triggers | body | Array | No | Nested triggers with actions: [{given, when, then, name?, actions?: [{description, weight?, parameterId?, learnCategory?, learnKeyPrefix?, learnKeyHint?}]}] |

**Response** `200`
```json
{ ok: true, spec: AnalysisSpec }
```

**Response** `400`
```json
{ ok: false, error: "slug and name are required" }
```

**Response** `400`
```json
{ ok: false, error: "Unknown parameter(s): ..." }
```

**Response** `409`
```json
{ ok: false, error: "Spec with slug '...' already exists" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/analysis-specs/:specId

Delete an analysis spec and all nested data (cascades triggers, actions, etc.)

**Auth**: Session · **Scope**: `analysis-specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID |

**Response** `200`
```json
{ ok: true, deleted: true }
```

**Response** `404`
```json
{ ok: false, error: "Spec not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/analysis-specs/:specId

Get a single analysis spec with full nested data including triggers, actions, parameters with scoring anchors, behavior targets, and linked BDDFeatureSet

**Auth**: Session · **Scope**: `analysis-specs:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID or slug |

**Response** `200`
```json
{ ok: true, spec: AnalysisSpec, featureSet: BDDFeatureSet|null }
```

**Response** `404`
```json
{ ok: false, error: "Spec not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PATCH` /api/analysis-specs/:specId

Partial update for promptTemplate, config, or specRole. Respects lock status. Marks spec as dirty.

**Auth**: Session · **Scope**: `analysis-specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID |
| promptTemplate | body | string | No | Updated prompt template |
| config | body | object | No | Updated config JSON |
| specRole | body | string | No | Updated spec role |

**Response** `200`
```json
{ ok: true, spec: AnalysisSpec }
```

**Response** `404`
```json
{ ok: false, error: "Spec not found" }
```

**Response** `423`
```json
{ ok: false, error: "Spec is locked and cannot be modified", locked: true }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PUT` /api/analysis-specs/:specId

Update an analysis spec's metadata. Respects lock status. Marks spec as dirty if content changes. Allows toggling isActive on locked specs.

**Auth**: Session · **Scope**: `analysis-specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID |
| name | body | string | No | Updated name |
| description | body | string | No | Updated description |
| outputType | body | string | No | Updated output type |
| scope | body | string | No | Updated scope |
| domain | body | string | No | Updated domain |
| priority | body | number | No | Updated priority |
| isActive | body | boolean | No | Enable or disable spec |
| version | body | string | No | Updated version |
| forceUnlock | body | boolean | No | Override lock protection |

**Response** `200`
```json
{ ok: true, spec: AnalysisSpec, wasCompiled: boolean }
```

**Response** `404`
```json
{ ok: false, error: "Spec not found" }
```

**Response** `423`
```json
{ ok: false, error: "Spec is locked and cannot be modified", locked: true }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/analysis-specs/:specId/compile

Get compilation status for a spec (compiled/dirty/locked state)

**Auth**: Session · **Scope**: `analysis-specs:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID or slug |

**Response** `200`
```json
{ ok: true, status: { isCompiled, isDirty, dirtyReason, compiledAt, compiledSetId, isLocked, lockedReason, usageCount } }
```

**Response** `404`
```json
{ ok: false, error: "Spec not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/analysis-specs/:specId/compile

Compile a spec: validate triggers/actions/parameters/anchors, and mark as compiled if validation passes

**Auth**: Session · **Scope**: `analysis-specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID or slug |
| force | body | boolean | No | Compile even with critical errors (default: false) |

**Response** `200`
```json
{ ok: true, spec: AnalysisSpec, validation: { passed, errors, warnings }, message: string }
```

**Response** `404`
```json
{ ok: false, error: "Spec not found" }
```

**Response** `423`
```json
{ ok: false, error: "Spec is locked and cannot be compiled..." }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/analysis-specs/:specId/enrich

Get enrichment status for a spec (total parameters, enriched count, percentage)

**Auth**: Session · **Scope**: `analysis-specs:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID or slug |

**Response** `200`
```json
{ ok: true, status: { totalParameters, enrichedParameters, percentEnriched } }
```

**Response** `404`
```json
{ ok: false, error: "Spec not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/analysis-specs/:specId/enrich

Enrich a spec by extracting key terms from actions and searching knowledge artifacts. Currently a placeholder returning term previews. Future: full knowledge retrieval integration.

**Auth**: Session · **Scope**: `analysis-specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID or slug |

**Response** `200`
```json
{ ok: true, message: string, enriched: number, spec: { id, name, actionCount }, terms: string[], hint: string }
```

**Response** `404`
```json
{ ok: false, error: "Spec not found" }
```

**Response** `423`
```json
{ ok: false, error: "Spec is locked and cannot be enriched" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/analysis-specs/:specId/export-to-source

"Send to Source" -- merges config.parameters back into the source .spec.json file on disk, then re-seeds the spec through the full pipeline (BDDFeatureSet -> Parameters -> AnalysisSpec -> etc.)

**Auth**: Session · **Scope**: `analysis-specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID |

**Response** `200`
```json
{ ok: true, filePath: string, message: string, seedResult: object }
```

**Response** `400`
```json
{ ok: false, error: "Spec has no linked BDDFeatureSet..." }
```

**Response** `400`
```json
{ ok: false, error: "Spec config is empty or has no parameters to export" }
```

**Response** `404`
```json
{ ok: false, error: "Spec not found" }
```

**Response** `423`
```json
{ ok: false, error: "Spec is locked and cannot be exported", locked: true }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/analysis-specs/:specId/recompile

Recompile a spec from its linked BDDFeatureSet.rawSpec. Regenerates promptTemplate, updates config for IDENTITY/CONTENT specs, and clears dirty state.

**Auth**: Session · **Scope**: `analysis-specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID |

**Response** `200`
```json
{ ok: true, spec: AnalysisSpec, recompiled: true, compiledAt: string }
```

**Response** `400`
```json
{ ok: false, error: "Spec has no linked BDDFeatureSet - cannot recompile" }
```

**Response** `400`
```json
{ ok: false, error: "BDDFeatureSet has no rawSpec - cannot recompile" }
```

**Response** `404`
```json
{ ok: false, error: "Spec not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/analysis-specs/:specId/triggers

Delete a trigger and its actions from a spec. Marks spec as dirty.

**Auth**: Session · **Scope**: `analysis-specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID |
| triggerId | body | string | No | Trigger UUID (required) |

**Response** `200`
```json
{ ok: true }
```

**Response** `400`
```json
{ ok: false, error: "triggerId is required" }
```

**Response** `404`
```json
{ ok: false, error: "Trigger not found or does not belong to this spec" }
```

**Response** `423`
```json
{ ok: false, error: "Spec is locked and cannot be modified", locked: true }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PATCH` /api/analysis-specs/:specId/triggers

Update a trigger's fields and optionally replace its actions. Marks spec as dirty.

**Auth**: Session · **Scope**: `analysis-specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID |
| triggerId | body | string | No | Trigger UUID (required) |
| given | body | string | No | Given condition |
| when | body | string | No | When event |
| then | body | string | No | Then outcome |
| name | body | string | No | Trigger display name |
| notes | body | string | No | Optional notes |
| actions | body | Array | No | If provided, replaces all actions: [{description, weight?, parameterId?, learnCategory?, learnKeyPrefix?, learnKeyHint?}] |

**Response** `200`
```json
{ ok: true, trigger: AnalysisTrigger }
```

**Response** `400`
```json
{ ok: false, error: "triggerId is required" }
```

**Response** `404`
```json
{ ok: false, error: "Trigger not found or does not belong to this spec" }
```

**Response** `423`
```json
{ ok: false, error: "Spec is locked and cannot be modified", locked: true }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/analysis-specs/:specId/triggers

Add a trigger (with optional actions) to a spec. Validates parameter IDs for MEASURE specs. Marks spec as dirty.

**Auth**: Session · **Scope**: `analysis-specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID |
| given | body | string | No | Given condition (required) |
| when | body | string | No | When event (required) |
| then | body | string | No | Then outcome (required) |
| name | body | string | No | Trigger display name |
| notes | body | string | No | Optional notes |
| actions | body | Array | No | Optional actions: [{description, weight?, parameterId?, learnCategory?, learnKeyPrefix?, learnKeyHint?}] |

**Response** `200`
```json
{ ok: true, trigger: AnalysisTrigger }
```

**Response** `400`
```json
{ ok: false, error: "given, when, and then are required" }
```

**Response** `400`
```json
{ ok: false, error: "Unknown parameter(s): ..." }
```

**Response** `404`
```json
{ ok: false, error: "Spec not found" }
```

**Response** `423`
```json
{ ok: false, error: "Spec is locked and cannot be modified", locked: true }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Analytics

### `GET` /api/analytics

Returns aggregated analytics data for the dashboard including learner progress,

**Auth**: Session · **Scope**: `analytics:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| days | query | number | No | Lookback period in days (default: 30) |

**Response** `200`
```json
{ ok: true, period, learnerProgress, goals, onboarding, pipeline, activity }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Auth

### `GET` /api/auth/[...nextauth]

NextAuth.js catch-all route handler for OAuth flows, session management, CSRF tokens, and sign-in/sign-out pages.

**Auth**: None · **Scope**: `auth:nextauth`

**Response** `200`
```json
HTML page or JSON session data depending on the route path
```

---

### `POST` /api/auth/[...nextauth]

NextAuth.js catch-all route handler for OAuth callbacks, credential sign-in, and session updates.

**Auth**: None · **Scope**: `auth:nextauth`

**Response** `200`
```json
Redirect or JSON response depending on the auth action
```

---

### `POST` /api/auth/login

Validates a superadmin bearer token and returns access credentials. Used for programmatic/API access.

**Auth**: None · **Scope**: `auth:login`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| token | body | string | No | The HF_SUPERADMIN_TOKEN to validate |

**Response** `200`
```json
{ accessToken: "...", permissions: "SUPERADMIN" }
```

**Response** `401`
```json
{ error: "Invalid token" }
```

**Response** `429`
```json
{ error: "Too many attempts..." }
```

**Response** `500`
```json
{ error: "Server misconfigured" }
```

---

## Callers

### `GET` /api/caller-graph/:callerId

Build a caller-centric knowledge graph with nodes and edges for visualization. Includes personality, memories, calls, goals, targets, and identities.

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID to build graph for |

**Response** `200`
```json
{ ok: true, caller: { id, name }, nodes: Array<{ id, label, type, slug?, group?, details?, value?, status? }>, edges: Array<{ from, to, type }>, counts: { nodes, edges, byType } }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/callers

List all callers with optional memory/call counts. Returns paginated results ordered by creation date descending, with flattened domain and personality data.

**Auth**: Session · **Scope**: `callers:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| withCounts | query | boolean | No | When "true", fetches active memory and call counts per caller |
| includeArchived | query | boolean | No | When "true", includes archived callers (default false) |
| role | query | string | No | Filter by caller role (LEARNER, TEACHER, TUTOR, PARENT, MENTOR) |
| limit | query | number | No | Maximum callers to return (default 100, max 500) |
| offset | query | number | No | Number of callers to skip for pagination (default 0) |

**Response** `200`
```json
{ ok: true, callers: Caller[], total: number, limit: number, offset: number }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch callers" }
```

---

### `POST` /api/callers

Create a new caller. Auto-assigns the default domain if none specified. Generates a playground externalId.

**Auth**: Session · **Scope**: `callers:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| name | body | string | No | Caller name (required) |
| email | body | string | No | Caller email (optional) |
| phone | body | string | No | Caller phone number (optional) |
| domainId | body | string | No | Domain ID to assign (optional, defaults to system default domain) |
| role | body | string | No | Caller role (optional, default LEARNER) |

**Response** `200`
```json
{ ok: true, caller: { id, name, email, phone, role, domain } }
```

**Response** `400`
```json
{ ok: false, error: "Name is required" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to create caller" }
```

---

### `DELETE` /api/callers/:callerId

Delete a caller and all associated data. Optionally exclude their identifiers from future imports.

**Auth**: Session · **Scope**: `callers:delete`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID to delete |
| exclude | body | boolean | No | Add phone/externalId to ExcludedCaller table (default: false) |

**Response** `200`
```json
{ ok: true, message: string, excluded: boolean }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/callers/:callerId

Get comprehensive caller data including profile, personality, memories, calls, scores, goals, curriculum, and learner profile

**Auth**: Session · **Scope**: `callers:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID |

**Response** `200`
```json
{ ok: true, caller: object, personalityProfile: object, observations: Array, memories: Array, memorySummary: object, calls: Array, identities: Array, scores: Array, callerTargets: Array, curriculum: object, learnerProfile: object, goals: Array, counts: object }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `PATCH` /api/callers/:callerId

Update caller profile fields. Domain changes trigger goal archival and new goal creation from playbook.

**Auth**: Session · **Scope**: `callers:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID |
| name | body | string | No | Caller display name |
| email | body | string | No | Caller email |
| phone | body | string | No | Caller phone number |
| domainId | body | string | No | New domain ID (triggers domain switch if different) |
| role | body | string | No | Caller role (LEARNER, TEACHER, TUTOR, PARENT, MENTOR) |
| archive | body | boolean | No | Set true to archive, false to unarchive |

**Response** `200`
```json
{ ok: true, caller: object, goalsCreated?: string[] }
```

**Response** `400`
```json
{ ok: false, error: "Domain not found" }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/callers/:callerId/actions

List call actions for a caller. Optionally filter by status, assignee, or callId.

**Auth**: Session · **Scope**: `callers:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID |

**Response** `200`
```json
{ ok: true, actions: CallAction[], counts: { pending, completed, total } }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

---

### `POST` /api/callers/:callerId/actions

Create a manual action for a caller (operator drops something in).

**Auth**: Session · **Scope**: `callers:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID |

**Response** `201`
```json
{ ok: true, action: CallAction }
```

**Response** `400`
```json
{ ok: false, error: string }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

---

### `DELETE` /api/callers/:callerId/actions/:actionId

Delete a call action.

**Auth**: Session · **Scope**: `callers:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID |
| actionId | path | string | Yes | The action ID |

**Response** `200`
```json
{ ok: true }
```

**Response** `404`
```json
{ ok: false, error: string }
```

---

### `PATCH` /api/callers/:callerId/actions/:actionId

Update a call action (status, notes, assignee, priority, dueAt).

**Auth**: Session · **Scope**: `callers:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID |
| actionId | path | string | Yes | The action ID |

**Response** `200`
```json
{ ok: true, action: CallAction }
```

**Response** `404`
```json
{ ok: false, error: string }
```

---

### `GET` /api/callers/:callerId/aggregate

Get available AGGREGATE specs for a caller. Returns all active specs with outputType AGGREGATE that can be run.

**Auth**: Session · **Scope**: `callers:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID to query aggregate specs for |

**Response** `200`
```json
{ ok: true, callerId: string, availableSpecs: { slug: string, name: string, description: string }[] }
```

**Response** `500`
```json
{ ok: false, error: "Failed to get aggregate specs" }
```

---

### `POST` /api/callers/:callerId/aggregate

Run all active AGGREGATE specs to compute derived attributes from measurements for a caller. Finds active AGGREGATE specs, reads aggregationRules from spec config, queries recent CallScores for source parameters, applies aggregation logic (thresholds, averages), and updates CallerAttribute (e.g., learner profile).

**Auth**: Session · **Scope**: `pipeline:execute`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID to run aggregation for |

**Response** `200`
```json
{ ok: true, callerId: string, specsRun: number, profileUpdates: object[], errors: string[], timestamp: string }
```

**Response** `500`
```json
{ ok: false, error: "Failed to run aggregate specs" }
```

---

### `GET` /api/callers/:callerId/artifacts

List conversation artifacts for a caller. Optionally filter by callId or status.

**Auth**: Session · **Scope**: `callers:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID |

**Response** `200`
```json
{ ok: true, artifacts: ConversationArtifact[] }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

---

### `POST` /api/callers/:callerId/calls

Create a new call record for a caller. Auto-determines call sequence number if not provided. Links to previous call for chain tracking.

**Auth**: Session · **Scope**: `callers:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID to create a call for |
| source | body | string | No | Call source identifier (default: "ai-simulation") |
| callSequence | body | number | No | Explicit sequence number (optional, auto-incremented if omitted) |
| transcript | body | string | No | Call transcript text (default: "") |

**Response** `200`
```json
{ ok: true, call: { id, callSequence, source, createdAt } }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to create call" }
```

---

### `GET` /api/callers/:callerId/compose-prompt

Get composed prompt history for a caller. Returns prompts ordered by composition date descending, with optional status filtering.

**Auth**: Session · **Scope**: `callers:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID to fetch prompt history for |
| limit | query | number | No | Maximum prompts to return (default 20) |
| status | query | string | No | Filter by status: "active", "superseded", or "all" (default: all) |

**Response** `200`
```json
{ ok: true, prompts: ComposedPrompt[], count: number }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch prompts" }
```

---

### `POST` /api/callers/:callerId/compose-prompt

Compose a personalized next-call prompt for a caller using the declarative composition pipeline driven by COMP-001 spec sections. Loads caller data, applies section transformations, renders a deterministic prompt summary, stores the result, and supersedes previous active prompts.

**Auth**: Session · **Scope**: `callers:compose`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID to compose a prompt for |
| triggerType | body | string | No | What triggered this composition (default: "manual") |
| triggerCallId | body | string | No | Optional call ID that triggered this composition |
| targetOverrides | body | object | No | Preview overrides for behavior targets (not persisted) |

**Response** `200`
```json
{ ok: true, prompt: ComposedPrompt, metadata: { engine, model, usage, inputContext, composition } }
```

**Response** `500`
```json
{ ok: false, error: "Failed to compose prompt" }
```

---

### `GET` /api/callers/:callerId/exam-readiness

Compute exam readiness for a caller across all active curricula (or one specific)

**Auth**: Session · **Scope**: `callers:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID |

**Response** `200`
```json
{ ok: true, curricula: ExamReadinessResult[] }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

---

### `POST` /api/callers/:callerId/exam-readiness

Submit formative assessment results or record an exam result

**Auth**: Session · **Scope**: `callers:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID |

**Response** `200`
```json
{ ok: true, readiness: ExamReadinessResult }
```

**Response** `400`
```json
{ ok: false, error: string }
```

---

### `GET` /api/callers/:callerId/export

Export all data for a caller (GDPR Subject Access Request).

**Auth**: Session · **Scope**: `callers:read`

---

### `POST` /api/callers/:callerId/reset

Reset all analysis data for a caller while preserving source calls/transcripts. Deletes CallScores, BehaviorMeasurements, RewardScores, PromptSlugSelections, CallerMemory, CallerMemorySummary, PersonalityObservations, CallerPersonality, CallerPersonalityProfile, ComposedPrompts, CallTargets, CallerTargets, and CALLER-scoped BehaviorTargets. Clears CallerIdentity fields and resets call sequence numbers. Preserves Caller record, Call records (transcripts), and CallerIdentity structure.

**Auth**: Session · **Scope**: `callers:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID to reset analysis data for |

**Response** `200`
```json
{ ok: true, message: string, deleted: { scores, behaviorMeasurements, rewardScores, callTargets, slugSelections, memories, memorySummary, observations, personalityProfiles, personality, prompts, callerTargets, behaviorTargets, identitiesCleared, callSequencesReset, callsPreserved } }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to reset caller" }
```

---

### `GET` /api/callers/:callerId/slugs

Returns all resolved template variables/slugs for a specific caller as a hierarchical tree. Shows values currently available for prompt composition including Identity/Content/Voice from playbook specs, Memories from LEARN specs, Scores from MEASURE specs, and Personalized targets from ADAPT specs. Also identifies template variables that are defined but not yet populated.

**Auth**: Session · **Scope**: `callers:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID to fetch slugs for |

**Response** `200`
```json
{ ok: true, caller: { id, name, domain }, playbook: { id, name, status } | null, tree: SlugNode[], counts: { memories, scores, targets, available, total } }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch caller slugs" }
```

---

### `GET` /api/callers/:callerId/snapshot

Download a complete snapshot of a caller's analysis state as a JSON file attachment. Includes caller profile, personality data (aggregate, profiles, observations), all memories, all call scores, calls with transcripts, caller identities, composed prompts, playbook info, and summary statistics. Useful for comparing analysis results across playbook configurations, archiving before reset, and debugging/auditing.

**Auth**: Session · **Scope**: `callers:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID to snapshot |
| includeTranscripts | query | boolean | No | Whether to include call transcripts (default: true, set to "false" to exclude) |
| label | query | string | No | Optional label to include in the snapshot metadata and filename |

**Response** `200`
```json
application/json attachment: { _meta, summary, caller, personality, memory, calls, identities, composedPrompts }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to create snapshot" }
```

---

### `POST` /api/callers/:callerId/switch-domain

Switch a caller to a new domain. Archives old goals, creates new goals from the new domain's playbook, and optionally triggers re-onboarding.

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID |
| domainId | body | string | No | The target domain ID (required) |
| skipOnboarding | body | boolean | No | Skip re-onboarding flow (default: false) |

**Response** `200`
```json
{ ok: true, message: string, caller: object, previousDomain: object, newDomain: object, archivedGoalsCount: number, newGoals: string[], onboardingRequired: boolean, onboardingSession: object }
```

**Response** `400`
```json
{ ok: false, error: "domainId is required" | "Caller is already in this domain" }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" | "Domain not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/callers/:callerId/trust-progress

Compute trust-weighted progress for a caller across all active curricula

**Auth**: Session · **Scope**: `callers:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | The caller ID |

**Response** `200`
```json
{ ok: true, curricula: TrustProgressEntry[] }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `POST` /api/callers/merge

Merge multiple source callers into a single target caller. Moves all data (calls, memories, observations, scores, identities, composed prompts, slug selections) from source callers to the target. Handles unique constraints by merging personality, personality profiles, memory summaries, caller targets, and caller attributes using weighted averages. Re-sequences calls chronologically. Deletes source callers after merge.

**Auth**: Session · **Scope**: `callers:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| targetCallerId | body | string | No | The caller ID that will receive all merged data (required) |

**Response** `200`
```json
{ ok: true, message: string, merged: { calls, memories, observations, scores, identities, composedPrompts, callerTargets, attributes, promptSlugSelections, personality, personalityProfile, memorySummary }, deletedCallers: number, targetCaller: { id, name, email } }
```

**Response** `400`
```json
{ ok: false, error: "Target caller ID required" }
```

**Response** `400`
```json
{ ok: false, error: "At least one source caller required" }
```

**Response** `400`
```json
{ ok: false, error: "Target caller cannot be in source list" }
```

**Response** `404`
```json
{ ok: false, error: "Callers not found: ..." }
```

**Response** `500`
```json
{ ok: false, error: "Failed to merge callers" }
```

---

## Calls

### `GET` /api/calls

List calls with optional filtering by caller. Returns calls with scores, memories, behavior measurements, triggered prompts, and pipeline status.

**Auth**: Session · **Scope**: `calls:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| limit | query | number | No | Max number of calls to return (default: 100) |
| callerId | query | string | No | Filter calls by caller ID |

**Response** `200`
```json
{ ok: true, calls: Call[], count: number }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch calls" }
```

---

### `GET` /api/calls/:callId

Get detailed call data including basic call info, scores with parameter details, extracted memories, behavior measurements, reward score, triggered prompts, personality observation, and effective behavior targets (layered: SYSTEM -> PLAYBOOK -> SEGMENT -> CALLER).

**Auth**: Session · **Scope**: `calls:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callId | path | string | Yes | The call ID to retrieve |

**Response** `200`
```json
{ ok: true, call: Call, scores: CallScore[], memories: CallerMemory[], measurements: BehaviorMeasurement[], rewardScore: RewardScore | null, triggeredPrompts: ComposedPrompt[], personalityObservation: PersonalityObservation | null, effectiveTargets: EffectiveTarget[], counts: { scores, memories, measurements, prompts, targets } }
```

**Response** `404`
```json
{ ok: false, error: "Call not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch call" }
```

---

### `PATCH` /api/calls/:callId

Update call data (e.g., transcript or summary after AI simulation). Only provided fields are updated.

**Auth**: Session · **Scope**: `calls:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callId | path | string | Yes | The call ID to update |
| transcript | body | string | No | Updated call transcript (optional) |
| summary | body | string | No | Updated call summary (optional) |

**Response** `200`
```json
{ ok: true, call: Call }
```

**Response** `404`
```json
{ ok: false, error: "Call not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to update call" }
```

---

### `POST` /api/calls/:callId/end

End a call by running the full pipeline (mode="prompt") and composing the next prompt. Internally delegates to the pipeline endpoint.

**Auth**: Session · **Scope**: `calls:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callId | path | string | Yes | The call ID to end and process |
| engine | body | string | No | AI engine to use: "mock" | "claude" | "openai" (default: "claude") |

**Response** `200`
```json
{ ok: true, pipeline: { scoresCreated, memoriesCreated, measurementsCreated, callTargetsCreated, playbookUsed }, prompt: { composed: boolean, id?: string, length?: number, error?: string } }
```

**Response** `404`
```json
{ ok: false, error: "Call not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to end call" }
```

---

### `POST` /api/calls/:callId/ops/:opId

Run a specific analysis op on a single call. Valid ops: measure, learn, measure-agent, reward, adapt. Returns result with detailed logs for debugging.

**Auth**: Session · **Scope**: `calls:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callId | path | string | Yes | The call ID to run the op on |
| opId | path | string | Yes | The op to run: "measure" | "learn" | "measure-agent" | "reward" | "adapt" |
| callerId | body | string | No | The caller ID (required) |
| engine | body | string | No | AI engine to use: "mock" | "claude" | "openai" (default: "claude") |

**Response** `200`
```json
{ ok: true, message: string, data: object, logs: LogEntry[], duration: number }
```

**Response** `400`
```json
{ ok: false, error: "callerId is required" | "Unknown op: ...", logs: LogEntry[], duration: number }
```

**Response** `500`
```json
{ ok: false, error: string, logs: LogEntry[], duration: number }
```

---

### `POST` /api/calls/:callId/pipeline

SPEC-DRIVEN pipeline endpoint that runs analysis in configurable stages. Pipeline stages are loaded from the PIPELINE-001 spec (or GUARD-001 fallback), not hardcoded. Each stage has a name, order, outputTypes, and optional requiresMode. Default stages: EXTRACT (10), SCORE_AGENT (20), AGGREGATE (30), REWARD (40), ADAPT (50), SUPERVISE (60), COMPOSE (100, prompt mode only).

**Auth**: Session · **Scope**: `pipeline:execute`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callId | path | string | Yes | The call ID to run the pipeline on |
| callerId | body | string | No | The caller ID (required) |
| mode | body | string | No | Pipeline mode: "prep" (all stages except COMPOSE) or "prompt" (all stages including COMPOSE) (required) |
| engine | body | string | No | AI engine to use: "mock" | "claude" | "openai" (default: "claude") |

**Response** `200`
```json
{ ok: true, mode: "prep" | "prompt", message: string, data: { scoresCreated, memoriesCreated, callTargetsCreated, agentMeasurements, ... }, prompt?: object, logs: LogEntry[], duration: number }
```

**Response** `400`
```json
{ ok: false, error: "callerId is required" | "mode must be 'prep' or 'prompt'", logs: LogEntry[] }
```

**Response** `404`
```json
{ ok: false, error: "Call not found", logs: LogEntry[] }
```

**Response** `500`
```json
{ ok: false, error: string, logs: LogEntry[], duration: number }
```

---

### `GET` /api/calls/[callId]/messages

Fetch messages for a call, optionally filtered by timestamp and role. Includes call ended status for observation polling.

**Auth**: Bearer token · **Scope**: `calls:read`

**Response** `200`
```json
{ ok: true, messages: [{ id, role, content, senderName, createdAt }], callEnded: boolean }
```

---

### `POST` /api/calls/[callId]/messages

Store a message during an active call for live observation relay. Validates role is "user" or "assistant".

**Auth**: Bearer token · **Scope**: `calls:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| role | body | string | No | Message role ("user" | "assistant") |
| content | body | string | No | Message content |

**Response** `200`
```json
{ ok: true, message: { id, role, content, createdAt } }
```

**Response** `400`
```json
{ ok: false, error: "role and content are required" }
```

**Response** `404`
```json
{ ok: false, error: "Call not found" }
```

---

### `GET` /api/calls/rewards

List reward scores across all calls, ordered by most recent. Includes associated call source and transcript.

**Auth**: Session · **Scope**: `calls:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| limit | query | number | No | Max number of reward scores to return (default: 100) |

**Response** `200`
```json
{ ok: true, scores: RewardScore[], count: number }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch reward scores" }
```

---

### `GET` /api/calls/scores

List call scores across all calls, ordered by most recent. Includes parameter details, call source/transcript, and run status.

**Auth**: Session · **Scope**: `calls:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| limit | query | number | No | Max number of scores to return (default: 100) |

**Response** `200`
```json
{ ok: true, scores: CallScore[], count: number }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch call scores" }
```

---

## Chat

### `POST` /api/chat

Sends a message to the AI chat assistant. Supports multiple modes (CHAT, DATA, SPEC, CALL) with mode-specific system prompts. Returns a streaming text response. Handles slash commands separately. Logs interactions for AI knowledge accumulation.

**Auth**: Session · **Scope**: `chat:send`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| message | body | string | No | User message text (required) |
| mode | body | string | No | Chat mode: "CHAT" | "DATA" | "SPEC" | "CALL" |
| engine | body | string | No | AI engine to use (optional, uses default if not specified) |

**Response** `200`
```json
text/plain (streaming response)
```

**Response** `400`
```json
{ ok: false, error: "Message is required" }
```

**Response** `500`
```json
{ ok: false, error: "...", errorCode: "BILLING" | "AUTH" | "RATE_LIMIT" | ... }
```

---

## Cohorts

### `GET` /api/callers/:callerId/cohorts

List cohort groups owned by a caller (teacher/tutor).

**Auth**: Session · **Scope**: `cohorts:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | path | string | Yes | Caller ID (the teacher/tutor) |

**Response** `200`
```json
{ ok: true, cohorts: CohortGroup[] }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch cohorts" }
```

---

### `GET` /api/cohorts

List cohort groups. Admins see all; teachers see only owned cohorts.

**Auth**: Session · **Scope**: `cohorts:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | query | string | No | Filter by domain (optional) |
| ownerId | query | string | No | Filter by owner caller ID (optional) |
| isActive | query | boolean | No | Filter by active status (optional, default true) |
| limit | query | number | No | Max results (default 100, max 500) |
| offset | query | number | No | Pagination offset (default 0) |

**Response** `200`
```json
{ ok: true, cohorts: CohortGroup[], total: number, limit: number, offset: number }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch cohorts" }
```

---

### `POST` /api/cohorts

Create a new cohort group. The authenticated user's linked caller becomes the owner.

**Auth**: Session · **Scope**: `cohorts:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| name | body | string | No | Cohort name (required) |
| description | body | string | No | Cohort description (optional) |
| domainId | body | string | No | Domain ID (required) |
| ownerId | body | string | No | Owner caller ID (optional, defaults to user's linked caller) |
| maxMembers | body | number | No | Maximum member count (optional, default 50) |

**Response** `200`
```json
{ ok: true, cohort: CohortGroup }
```

**Response** `400`
```json
{ ok: false, error: "..." }
```

**Response** `500`
```json
{ ok: false, error: "Failed to create cohort" }
```

---

### `DELETE` /api/cohorts/:cohortId

Delete a cohort group. Removes member assignments first, then deletes the group.

**Auth**: Session · **Scope**: `cohorts:delete`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| cohortId | path | string | Yes | Cohort group ID |

**Response** `200`
```json
{ ok: true, message: "Cohort deleted" }
```

**Response** `404`
```json
{ ok: false, error: "Cohort not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to delete cohort" }
```

---

### `GET` /api/cohorts/:cohortId

Get cohort detail with member list.

**Auth**: Session · **Scope**: `cohorts:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| cohortId | path | string | Yes | Cohort group ID |

**Response** `200`
```json
{ ok: true, cohort: CohortGroup, members: Caller[] }
```

**Response** `404`
```json
{ ok: false, error: "Cohort not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch cohort" }
```

---

### `PATCH` /api/cohorts/:cohortId

Update cohort name, description, maxMembers, or isActive.

**Auth**: Session · **Scope**: `cohorts:update`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| cohortId | path | string | Yes | Cohort group ID |
| name | body | string | No | New name (optional) |
| description | body | string | No | New description (optional) |
| maxMembers | body | number | No | New max member count (optional) |
| isActive | body | boolean | No | Active status (optional) |

**Response** `200`
```json
{ ok: true, cohort: CohortGroup }
```

**Response** `404`
```json
{ ok: false, error: "Cohort not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to update cohort" }
```

---

### `GET` /api/cohorts/:cohortId/activity

Recent activity feed for a cohort. Returns calls, goal updates, and

**Auth**: Session · **Scope**: `cohorts:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| cohortId | path | string | Yes | Cohort group ID |
| limit | query | number | No | Maximum items to return (default 50, max 200) |
| offset | query | number | No | Number of items to skip (default 0) |

**Response** `200`
```json
{ ok: true, activity, total, limit, offset }
```

**Response** `404`
```json
{ ok: false, error: "Cohort not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch activity" }
```

---

### `GET` /api/cohorts/:cohortId/dashboard

Aggregated dashboard stats for a cohort. Returns per-pupil call counts,

**Auth**: Session · **Scope**: `cohorts:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| cohortId | path | string | Yes | Cohort group ID |

**Response** `200`
```json
{ ok: true, cohort, summary, pupils }
```

**Response** `404`
```json
{ ok: false, error: "Cohort not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch dashboard" }
```

---

### `GET` /api/cohorts/:cohortId/invite

List pending invites for a cohort.

**Auth**: Session · **Scope**: `cohorts:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| cohortId | path | string | Yes | Cohort group ID |

**Response** `200`
```json
{ ok: true, invites }
```

---

### `POST` /api/cohorts/:cohortId/invite

Send email invites to pupils for this cohort. Creates Invite records

**Auth**: Session · **Scope**: `cohorts:update`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| cohortId | path | string | Yes | Cohort group ID |

**Response** `200`
```json
{ ok: true, created, skipped, sent }
```

**Response** `400`
```json
{ ok: false, error: string }
```

---

### `DELETE` /api/cohorts/:cohortId/join-link

Revoke the magic join link for a cohort.

**Auth**: Session · **Scope**: `cohorts:update`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| cohortId | path | string | Yes | Cohort group ID |

**Response** `200`
```json
{ ok: true, message: "Join link revoked" }
```

---

### `GET` /api/cohorts/:cohortId/join-link

Get the magic join link for a cohort. Generates one if none exists.

**Auth**: Session · **Scope**: `cohorts:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| cohortId | path | string | Yes | Cohort group ID |

**Response** `200`
```json
{ ok: true, joinToken }
```

---

### `POST` /api/cohorts/:cohortId/join-link

Regenerate the magic join link for a cohort.

**Auth**: Session · **Scope**: `cohorts:update`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| cohortId | path | string | Yes | Cohort group ID |

**Response** `200`
```json
{ ok: true, joinToken }
```

---

### `DELETE` /api/cohorts/:cohortId/members

Remove callers from a cohort group. Sets their cohortGroupId to null.

**Auth**: Session · **Scope**: `cohorts:update`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| cohortId | path | string | Yes | Cohort group ID |

**Response** `200`
```json
{ ok: true, removed: number }
```

**Response** `400`
```json
{ ok: false, error: "callerIds array is required" }
```

**Response** `404`
```json
{ ok: false, error: "Cohort not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to remove members" }
```

---

### `POST` /api/cohorts/:cohortId/members

Add callers to a cohort group. Validates all callers exist and belong to the same domain.

**Auth**: Session · **Scope**: `cohorts:update`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| cohortId | path | string | Yes | Cohort group ID |

**Response** `200`
```json
{ ok: true, added: number }
```

**Response** `400`
```json
{ ok: false, error: "..." }
```

**Response** `404`
```json
{ ok: false, error: "Cohort not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to add members" }
```

---

## Content Sources

### `GET` /api/content-sources/available

List content sources in a lightweight format for the source picker UI in the spec editor

**Auth**: Session · **Scope**: `content-sources:read`

**Response** `200`
```json
{ ok: true, sources: Array<{ slug, name, trustLevel, publisherOrg, validUntil, isExpired }> }
```

---

## Content Trust

### `GET` /api/content-sources/:sourceId

Get a content source by ID, including assertion count and freshness status

**Auth**: Session · **Scope**: `content-sources:read`

---

### `PATCH` /api/content-sources/:sourceId

Update a content source. Trust level changes are validated and logged.

**Auth**: Session · **Scope**: `content-sources:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| trustLevel | body | ContentTrustLevel | No | New trust level (optional) |
| verificationNotes | body | string | No | Notes explaining the trust level change (required when changing trust) |
| name | body | string | No | Updated name (optional) |
| description | body | string | No | Updated description (optional) |
| validUntil | body | string | No | Updated expiry date (optional) |
| isActive | body | boolean | No | Active status (optional) |
| supersededById | body | string | No | ID of newer source that replaces this one (optional) |

---

### `GET` /api/content-sources/:sourceId/assertions

List assertions for a content source with optional filtering

**Auth**: Session · **Scope**: `content-sources:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| sourceId | path | string | Yes |  |
| category | query | string | No | Filter by category (fact, definition, threshold, rule, process, example) |
| search | query | string | No | Search assertion text |
| limit | query | number | No | Max results (default 100) |
| offset | query | number | No | Pagination offset (default 0) |

**Response** `200`
```json
{ ok: true, assertions: ContentAssertion[], total: number }
```

---

### `POST` /api/content-sources/:sourceId/import

Upload a document (PDF, text, markdown) and extract ContentAssertions linked to this source.

**Auth**: Session · **Scope**: `content-sources:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| file | body | File | No | The document to parse (multipart/form-data) |
| focusChapters | body | string | No | Comma-separated chapter names to focus on (optional) |
| maxAssertions | body | number | No | Max assertions to extract (default: 500) |

**Response** `200`
```json
{ ok: true, assertions: ExtractedAssertion[], created: number, duplicatesSkipped: number, warnings: string[] }
```

**Response** `202`
```json
{ ok: true, jobId: string } (background mode)
```

---

### `GET` /api/content-sources/:sourceId/import?jobId=xxx

Poll the status of a background extraction job.

**Auth**: Session · **Scope**: `content-sources:read`

---

## Data Dictionary

### `GET` /api/data-dictionary/dependencies

Reverse dependency index: lists all active specs and published playbooks with the template variables and key prefixes each one uses. Extracts mustache variables from promptTemplates, trigger fields, and action descriptions. This is the "flip" of the xrefs endpoint.

**Auth**: Session · **Scope**: `data-dictionary:read`

**Response** `200`
```json
{ ok: true, specs: [...], playbooks: [...], summary: { totalSpecs, totalPlaybooks, specsWithVariables, specsWithPrefixes } }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch dependencies" }
```

---

### `GET` /api/data-dictionary/parameters

Returns all parameters enriched with cross-references: specs (via AnalysisAction), playbooks, behavior targets, prompt slugs, and scoring anchors. Supports filtering by domain group and orphan detection. Derives isActive from "active"/"mvp" tags.

**Auth**: Session · **Scope**: `data-dictionary:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainGroup | query | string | No | Filter by domain group (optional) |
| orphans | query | string | No | Show only orphaned parameters with no relationships ("true" to filter) |

**Response** `200`
```json
{ ok: true, parameters: [...], summary: { total, active, withSpecs, withPlaybooks, withTargets, withAnchors, orphaned, byDomainGroup } }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch parameters" }
```

---

### `GET` /api/data-dictionary/xrefs

Find cross-references for template variables and key prefixes across the system. Searches analysis specs (promptTemplate, trigger fields, action descriptions), prompt templates, prompt slugs, and playbooks. Without query params, returns all parameters as dictionary entries.

**Auth**: Session · **Scope**: `data-dictionary:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| type | query | string | No | Reference type to search: "variable" (mustache vars) or "prefix" (key prefixes) (optional) |
| pattern | query | string | No | The variable name (e.g. "{{memories.facts}}") or prefix (e.g. "location_") (optional) |

**Response** `200`
```json
{ ok: true, xrefs: [...] } (when no type/pattern)
```

**Response** `200`
```json
{ ok: true, pattern: "...", type: "...", xrefs: { analysisSpecs, promptTemplates, promptSlugs, playbooks }, counts: {...} }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch cross-references" }
```

---

## Dev Tools

### `POST` /api/x/cleanup-callers

Deletes all callers that have 0 calls (orphaned records). Removes related records (memories, attributes, targets, personality data) before deleting the caller.

**Auth**: Bearer token · **Scope**: `dev:cleanup`

**Response** `200`
```json
{ ok: true, message: "...", deleted: number, skipped: number, remaining: number, errors?: [...] }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/x/create-domains

Returns available playbooks from playbooks-config.json for selection UI, including spec counts and behavior target counts.

**Auth**: Bearer token · **Scope**: `dev:read`

**Response** `200`
```json
{ ok: true, playbooks: [{ id, name, description, domain, status, specCount, behaviorTargetCount, identitySpecs, contentSpecs, requiredSpecs, optionalSpecs, systemDomains }] }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/x/create-domains

Creates domains and playbooks from playbooks-config.json. Ensures behavior parameters exist, creates SYSTEM-level BehaviorTargets, then creates selected or all domains and playbooks with auto-linked specs. All created playbooks are set to PUBLISHED status.

**Auth**: Bearer token · **Scope**: `dev:seed`

**Response** `200`
```json
{ ok: boolean, message: "...", details: { domainsCreated: [...], playbooksCreated: [...], specsLinked: number, parametersCreated: number, systemTargetsCreated: number, errors: [...] } }
```

**Response** `400`
```json
{ ok: false, error: "No playbooks found to create" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/x/data-management/stats

Returns current database statistics including counts of domains, playbooks, specs, callers, and calls.

**Auth**: Bearer token · **Scope**: `dev:stats`

**Response** `200`
```json
{ ok: true, stats: { domains: number, playbooks: number, specs: number, callers: number, calls: number } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/x/seed-domains

Creates default domains (WNF TUTOR and COMPANION) with all required infrastructure: domains, playbooks, analysis specs, parameters, prompt templates, behavior targets, and playbook items. Syncs BDD specs first to ensure all specs exist before linking to playbooks.

**Auth**: Bearer token · **Scope**: `dev:seed`

**Response** `200`
```json
{ ok: boolean, message: "...", details: { domainsCreated: [...], playbooksCreated: [...], specsCreated: number, specsSynced: number, parametersCreated: number, errors: [...] } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/x/seed-system

Full metadata-driven system initialization. Steps: 1) Syncs all BDD specs from docs-archive/bdd-specs/ directory, 2) Ensures behavior parameters from canonical registry, 3) Creates SYSTEM-level BehaviorTargets, 4) Creates domains and playbooks from playbooks-config.json, 5) Validates cross-references against registry.

**Auth**: Bearer token · **Scope**: `dev:seed`

**Response** `200`
```json
{ ok: boolean, message: "...", validationWarnings?: [...], details: { domainsCreated: [...], playbooksCreated: [...], specsCreated: number, specsSynced: number, parametersCreated: number, errors: [...] } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/x/seed-transcripts

Recursively imports all transcript files (.json, .txt) from HF_KB_PATH/sources/transcripts/raw. Wraps the /api/transcripts/import endpoint. In "replace" mode, deletes ALL existing callers and calls first. In "keep" mode, skips duplicates.

**Auth**: Bearer token · **Scope**: `dev:seed`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| mode | body | string | No | "replace" (delete all first) or "keep" (skip duplicates, default) |

**Response** `200`
```json
{ ok: true, message: "...", sourceDir: "...", mode: "...", details: {...} }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/x/spec-schema

Returns the BDD feature spec JSON schema from docs-archive/bdd-specs/feature-spec-schema.json.

**Auth**: Bearer token · **Scope**: `dev:read`

**Response** `200`
```json
{ ok: true, schema: {...} }
```

**Response** `404`
```json
{ ok: false, error: "Schema file not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/x/spec-schema

Uploads a .spec.json file, validates its structure (id, title, version, story, parameters), and saves it to the docs-archive/bdd-specs/ directory. Supports overwrite of existing specs.

**Auth**: Bearer token · **Scope**: `dev:upload`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| file | body | File | No | Multipart form-data file upload (.spec.json extension required) |

**Response** `200`
```json
{ ok: true, message: "...", spec: { id, title, version, domain, specType, parameterCount }, filename: "...", isOverwrite: boolean }
```

**Response** `400`
```json
{ ok: false, error: "Expected multipart/form-data" | "No file uploaded" | "File must have .spec.json extension" | "Invalid JSON..." | "Validation failed", validationErrors?: [...] }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/x/sync-specs

Returns sync status comparing filesystem .spec.json files to BDDFeatureSet database records. Shows which specs are synced vs unsynced.

**Auth**: Bearer token · **Scope**: `dev:read`

**Response** `200`
```json
{ ok: true, totalFiles: number, syncedFiles: number, unsyncedFiles: number, unsyncedList: [...] }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/x/sync-specs

Syncs all BDD specs from docs-archive/bdd-specs/*.spec.json directory into the database. Creates/updates Parameters, AnalysisSpecs, Anchors, and PromptSlugs. Extracted as STEP 1 from the seed-system endpoint.

**Auth**: Bearer token · **Scope**: `dev:seed`

**Response** `200`
```json
{ ok: true, message: "...", details: { specsProcessed: number, parametersCreated: number, parametersUpdated: number, results: [...] } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Domains

### `GET` /api/domains

List all domains with caller counts and playbook info

**Auth**: Session · **Scope**: `domains:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| includeInactive | query | boolean | No | Include inactive domains (default: false) |

**Response** `200`
```json
{ ok: true, domains: Domain[], count: number }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/domains

Create a new domain

**Auth**: Session · **Scope**: `domains:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| slug | body | string | No | Unique domain slug |
| name | body | string | No | Display name |
| description | body | string | No | Optional description |
| isDefault | body | boolean | No | Set as default domain |

**Response** `200`
```json
{ ok: true, domain: Domain }
```

**Response** `400`
```json
{ ok: false, error: "slug and name are required" }
```

**Response** `409`
```json
{ ok: false, error: "Domain with slug ... already exists" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/domains/:domainId

Soft-delete a domain by setting isActive = false. Blocks if domain is default or has callers.

**Auth**: Session · **Scope**: `domains:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | path | string | Yes | Domain UUID |

**Response** `200`
```json
{ ok: true, message: "Domain deactivated" }
```

**Response** `400`
```json
{ ok: false, error: "Cannot delete the default domain" }
```

**Response** `400`
```json
{ ok: false, error: "Cannot delete domain with N callers assigned..." }
```

**Response** `404`
```json
{ ok: false, error: "Domain not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/domains/:domainId

Get domain details with callers and playbooks

**Auth**: Session · **Scope**: `domains:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | path | string | Yes | Domain UUID |

**Response** `200`
```json
{ ok: true, domain: Domain }
```

**Response** `404`
```json
{ ok: false, error: "Domain not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PATCH` /api/domains/:domainId

Update a domain's name, description, default status, or active status

**Auth**: Session · **Scope**: `domains:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | path | string | Yes | Domain UUID |
| name | body | string | No | Updated display name |
| description | body | string | No | Updated description |
| isDefault | body | boolean | No | Set as default domain |
| isActive | body | boolean | No | Enable or disable domain |

**Response** `200`
```json
{ ok: true, domain: Domain }
```

**Response** `404`
```json
{ ok: false, error: "Domain not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/domains/:domainId/classroom

Auto-create a classroom (cohort + join link) for a domain.

**Auth**: OPERATOR

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | path | string | Yes | Domain ID |
| name | body | string | No | Classroom name (optional, defaults to "{domain.name} Classroom") |

**Response** `200`
```json
{ ok: true, cohort: CohortGroup, joinToken: string }
```

**Response** `404`
```json
{ ok: false, error: "Domain not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `POST` /api/domains/:domainId/generate-content-spec

Auto-generate a CONTENT spec from the domain's content source assertions.

**Auth**: session (OPERATOR)

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | path | string | Yes | The domain ID |

**Response** `200`
```json
{ ok: true, result: ContentSpecResult }
```

**Response** `404`
```json
{ ok: false, error: "Domain not found: ..." }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/domains/:domainId/onboarding

Get domain onboarding configuration including welcome message, identity spec, flow phases, and default targets

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | path | string | Yes | The domain ID |

**Response** `200`
```json
{ ok: true, domain: object, identitySpecs: Array<{ id, slug, name, description }> }
```

**Response** `404`
```json
{ ok: false, error: "Domain not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `PUT` /api/domains/:domainId/onboarding

Update domain onboarding configuration (welcome message, identity spec, flow phases, default targets)

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | path | string | Yes | The domain ID |
| onboardingWelcome | body | string | No | Welcome message text |
| onboardingIdentitySpecId | body | string | No | Identity spec ID for onboarding |
| onboardingFlowPhases | body | object | No | Phase configuration for onboarding flow |
| onboardingDefaultTargets | body | object | No | Default behavior targets for new callers |

**Response** `200`
```json
{ ok: true, domain: object }
```

**Response** `400`
```json
{ ok: false, error: "Identity spec not found" | "Spec must have specRole=IDENTITY" }
```

**Response** `404`
```json
{ ok: false, error: "Domain not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `POST` /api/domains/:domainId/preview-prompt

Preview the first-call composed prompt for a domain without persisting it. Uses an existing caller in the domain or creates a minimal preview caller if none exist.

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | path | string | Yes | The domain ID to preview the prompt for |

**Response** `200`
```json
{ ok: true, promptSummary, voicePrompt, llmPrompt, metadata }
```

**Response** `404`
```json
{ ok: false, error: "Domain not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/domains/:domainId/readiness

Check if a domain is ready to receive calls. Evaluates checks defined in DOMAIN-READY-001 ORCHESTRATE spec. Returns structured pass/fail results with fix action links.

**Auth**: Session · **Scope**: `domains:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | path | string | Yes | The domain ID to check readiness for |

**Response** `200`
```json
{ ok: true, domainId, domainName, ready, score, level, checks[], criticalPassed, criticalTotal, recommendedPassed, recommendedTotal }
```

**Response** `404`
```json
{ ok: false, error: "Domain not found: ..." }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `POST` /api/domains/:domainId/scaffold

Auto-scaffold minimum viable domain setup: identity spec, playbook, publish, onboarding config.

**Auth**: session (OPERATOR)

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | path | string | Yes | The domain ID |

**Response** `200`
```json
{ ok: true, result: ScaffoldResult }
```

**Response** `404`
```json
{ ok: false, error: "Domain not found: ..." }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `POST` /api/domains/quick-launch

Runs the Quick Launch flow: upload content → create domain → scaffold tutor → ready.

**Auth**: OPERATOR

**Response** `200`
```json
text/event-stream — progress events then final result
```

---

### `POST` /api/domains/quick-launch/analyze

Non-blocking Quick Launch setup.

**Auth**: OPERATOR

**Response** `202`
```json
{ ok, domainId, subjectId, sourceId?, jobId?, taskId, mode }
```

---

### `POST` /api/domains/quick-launch/commit

Runs the commit phase of Quick Launch (Steps 5-7):

**Auth**: OPERATOR

**Response** `200`
```json
text/event-stream — progress events then final QuickLaunchResult
```

---

### `POST` /api/domains/suggest-name

AI-generates field suggestions (name, persona, goals) from a free-text brief.

**Auth**: OPERATOR

**Response** `200`
```json
{ ok, name, slug, persona?, goals? }
```

---

## Educator

### `POST` /api/calls/[callId]/interject

Teacher sends a message into an active student call. Verifies the call is active and belongs to a student in the educator's cohort. Creates a callMessage with role "teacher".

**Auth**: Bearer token · **Scope**: `calls:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| content | body | string | No | Message content to inject into the call |

**Response** `200`
```json
{ ok: true, message: { id, role, content, senderName, createdAt } }
```

**Response** `400`
```json
{ ok: false, error: "Message content is required" }
```

**Response** `400`
```json
{ ok: false, error: "Call has already ended" }
```

**Response** `404`
```json
{ ok: false, error: "Call not found" }
```

---

### `GET` /api/educator/active-calls

List active calls across the educator's students. Active = endedAt is null AND createdAt within last 2 hours.

**Auth**: Bearer token · **Scope**: `educator:read`

**Response** `200`
```json
{ ok: true, activeCalls: [{ callId, callerId, callerName, classroom, classroomId, startedAt }] }
```

---

### `GET` /api/educator/classrooms

List all classrooms (cohort groups) owned by the educator, including domain info, member counts, and last activity timestamps.

**Auth**: Bearer token · **Scope**: `educator:read`

**Response** `200`
```json
{ ok: true, classrooms: [{ id, name, description, domain, memberCount, maxMembers, isActive, joinToken, lastActivity, createdAt }] }
```

---

### `POST` /api/educator/classrooms

Create a new classroom (cohort group) for the educator. Generates a join token for magic invite links.

**Auth**: Bearer token · **Scope**: `educator:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| name | body | string | No | Classroom name (required) |
| description | body | string | No | Optional description |
| domainId | body | string | No | Domain to associate (required) |

**Response** `200`
```json
{ ok: true, classroom: { id, name, description, domain, memberCount, joinToken, createdAt } }
```

**Response** `400`
```json
{ ok: false, error: "Classroom name is required" }
```

**Response** `404`
```json
{ ok: false, error: "Domain not found" }
```

---

### `GET` /api/educator/classrooms/[id]

Get classroom detail with member roster and basic stats. Requires educator ownership of the cohort.

**Auth**: Bearer token · **Scope**: `educator:read`

**Response** `200`
```json
{ ok: true, classroom: { id, name, description, domain, memberCount, maxMembers, isActive, joinToken, createdAt }, members: [{ id, name, email, totalCalls, lastCallAt, joinedAt }] }
```

**Response** `403`
```json
{ ok: false, error: "Not authorized" }
```

---

### `PATCH` /api/educator/classrooms/[id]

Update classroom settings (name, description, isActive). Requires educator ownership of the cohort.

**Auth**: Bearer token · **Scope**: `educator:write`

**Response** `200`
```json
{ ok: true, classroom: { id, name, description, domain, memberCount, isActive } }
```

**Response** `400`
```json
{ ok: false, error: "No updates provided" }
```

**Response** `403`
```json
{ ok: false, error: "Not authorized" }
```

---

### `POST` /api/educator/classrooms/[id]/invite

Send email invites to students for this classroom. Creates TESTER-role invites with LEARNER caller role and 30-day expiry. Deduplicates against existing pending invites.

**Auth**: Bearer token · **Scope**: `educator:write`

**Response** `200`
```json
{ ok: true, created: number, skipped: number }
```

**Response** `400`
```json
{ ok: false, error: "At least one email is required" }
```

**Response** `403`
```json
{ ok: false, error: "Not authorized" }
```

---

### `GET` /api/educator/classrooms/[id]/invite-link

Get the magic join token for a classroom. Generates one if none exists. Requires educator ownership of the cohort.

**Auth**: Bearer token · **Scope**: `educator:read`

**Response** `200`
```json
{ ok: true, joinToken: string }
```

**Response** `403`
```json
{ ok: false, error: "Not authorized" }
```

---

### `POST` /api/educator/classrooms/[id]/invite-link

Regenerate the magic join token for a classroom, invalidating the previous link. Requires educator ownership of the cohort.

**Auth**: Bearer token · **Scope**: `educator:write`

**Response** `200`
```json
{ ok: true, joinToken: string }
```

**Response** `403`
```json
{ ok: false, error: "Not authorized" }
```

---

### `DELETE` /api/educator/classrooms/[id]/members/[callerId]

Remove a student from a classroom by unlinking them from the cohort. Does not delete the caller record. Requires educator ownership of the cohort.

**Auth**: Bearer token · **Scope**: `educator:write`

**Response** `200`
```json
{ ok: true }
```

**Response** `404`
```json
{ ok: false, error: "Student not found in this classroom" }
```

**Response** `403`
```json
{ ok: false, error: "Not authorized" }
```

---

### `GET` /api/educator/classrooms/[id]/progress

Cohort progress stats including calls-per-day trend (30 days), engagement breakdown (active/moderate/needsAttention/notStarted), and per-student call summary. Requires educator ownership of the cohort.

**Auth**: Bearer token · **Scope**: `educator:read`

**Response** `200`
```json
{ ok: true, callsPerDay: [{ date, count }], engagement: { active, moderate, needsAttention, notStarted, total }, summary: { totalCalls, uniqueActive7d }, perStudent: [{ id, name, totalCalls, recentCalls }] }
```

**Response** `403`
```json
{ ok: false, error: "Not authorized" }
```

---

### `GET` /api/educator/dashboard

Educator dashboard overview with classroom list, aggregate stats (total students, active this week), recent calls, and students needing attention (no calls in 7+ days).

**Auth**: Bearer token · **Scope**: `educator:read`

**Response** `200`
```json
{ ok: true, classrooms: [...], stats: { classroomCount, totalStudents, activeThisWeek }, recentCalls: [...], needsAttention: [...] }
```

---

### `POST` /api/educator/invite-teacher

Invite another educator (teacher) to the platform. Creates an EDUCATOR-role invite with TEACHER caller role and 30-day expiry. Returns the invite URL for sharing.

**Auth**: Bearer token · **Scope**: `educator:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| email | body | string | No | Email address (required) |

**Response** `200`
```json
{ ok: true, invite: { id, email, expiresAt }, inviteUrl: string }
```

**Response** `400`
```json
{ ok: false, error: "A valid email address is required" }
```

**Response** `400`
```json
{ ok: false, error: "A user with this email already exists" }
```

**Response** `400`
```json
{ ok: false, error: "An invite is already pending for this email" }
```

---

### `GET` /api/educator/reports

Aggregated analytics across all classrooms or filtered to a specific one. Includes student count, total/recent calls, engagement rate, and 30-day calls-per-day trend.

**Auth**: Bearer token · **Scope**: `educator:read`

**Response** `200`
```json
{ ok: true, classrooms: [...], stats: { totalStudents, totalCalls, callsThisWeek, activeStudents7d, engagementRate }, callsPerDay: [{ date, count }] }
```

---

### `GET` /api/educator/students

List all students across the educator's active classrooms, including classroom assignment, call counts, and last activity.

**Auth**: Bearer token · **Scope**: `educator:read`

**Response** `200`
```json
{ ok: true, students: [{ id, name, email, classroom, totalCalls, lastCallAt, joinedAt }] }
```

---

### `GET` /api/educator/students/[id]

Get detailed student view including recent call history (last 20), goals with progress, and personality profile parameter values. Requires educator access to the student's cohort.

**Auth**: Bearer token · **Scope**: `educator:read`

**Response** `200`
```json
{ ok: true, student: { id, name, email, classroom, domain, joinedAt }, calls: [...], goals: [...], profile: { parameterValues, lastUpdatedAt } | null }
```

**Response** `403`
```json
{ ok: false, error: "Not authorized" }
```

---

## Goals

### `GET` /api/goals

Fetch all goals across all callers with filtering options. Includes related caller, playbook, and content spec data. Returns aggregate counts grouped by status and type.

**Auth**: Session · **Scope**: `goals:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| status | query | string | No | Filter by goal status (optional, "all" for no filter) |
| type | query | string | No | Filter by goal type (optional, "all" for no filter) |
| callerId | query | string | No | Filter by caller ID (optional) |

**Response** `200`
```json
{ ok: true, goals: [...], counts: { total, byStatus: {...}, byType: {...} } }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch goals" }
```

---

## Invites

### `POST` /api/invite/accept

Accepts an invite: creates User account, marks invite used, sets session cookie for auto sign-in.

**Auth**: None

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| token | body | string | No | Invite token (required) |
| firstName | body | string | No | User's first name (required) |
| lastName | body | string | No | User's last name (required) |

**Response** `200`
```json
{ ok: true, user: { id, email, name, role } }
```

**Response** `400`
```json
{ ok: false, error: "..." }
```

**Response** `404`
```json
{ ok: false, error: "Invite not found, expired, or already used" }
```

---

### `GET` /api/invite/verify

Verifies an invite token and returns invite details for the accept form. Does not consume the invite.

**Auth**: None

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| token | query | string | No | Invite token to verify (required) |

**Response** `200`
```json
{ ok: true, invite: { email, firstName, lastName, domainName?, expiresAt } }
```

**Response** `400`
```json
{ ok: false, error: "Token is required" }
```

**Response** `404`
```json
{ ok: false, error: "Invite not found, expired, or already used" }
```

---

## Lab

### `GET` /api/lab/features

List compiled BDD feature sets with optional active filter and limit

**Auth**: Session · **Scope**: `lab:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| limit | query | number | No | Max results (default: 50) |
| active | query | string | No | Filter by active status ("true" or "false") |

**Response** `200`
```json
{ ok: true, features: BDDFeatureSet[] }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/lab/features/:id

Delete a BDD feature set by ID

**Auth**: Session · **Scope**: `lab:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Feature set ID |

**Response** `200`
```json
{ ok: true }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/lab/features/:id

Get a single BDD feature set with all related data (specs, parameters, prompt slugs, anchors)

**Auth**: Session · **Scope**: `lab:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Feature set ID |

**Response** `200`
```json
{ ok: true, feature: BDDFeatureSet }
```

**Response** `404`
```json
{ ok: false, error: "Feature set not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/lab/features/:id/activate

Activate or deactivate a BDDFeatureSet by creating/updating all derived records (Parameters, Anchors, AnalysisSpecs, Triggers, Actions, PromptSlugs, Curriculum). Full parity with seed-from-specs.ts.

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | The BDDFeatureSet ID |
| activate | body | boolean | No | True to activate, false to deactivate |

**Response** `200`
```json
{ ok: true, feature: object, spec: { id, slug, name, specRole, outputType }, results: { parametersCreated, parametersUpdated, anchorsCreated, specsCreated, triggersCreated, actionsCreated, promptSlugsCreated, curriculumCreated } }
```

**Response** `404`
```json
{ ok: false, error: "Feature set not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `POST` /api/lab/upload

One-step upload: accepts a JSON spec, creates BDDFeatureSet, activates to create AnalysisSpec.

**Auth**: Session · **Scope**: `lab:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| spec | body | object | No | The JSON spec definition to upload |

**Response** `200`
```json
{ ok: true, featureSet: { id, featureId, name, version }, spec: { id, slug, name, scope, outputType }, message: string }
```

**Response** `400`
```json
{ ok: false, error: "No spec provided..." }
```

**Response** `400`
```json
{ ok: false, error: "Invalid spec: ..." }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/lab/upload/preview

Preview what artifacts would be created/updated by uploading a spec (dry-run, no changes made)

**Auth**: Session · **Scope**: `lab:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| spec | body | object | No | The JSON spec definition to preview |

**Response** `200`
```json
{ ok: true, preview: { spec, story, artifacts: { featureSet, analysisSpec, parameters }, warnings } }
```

**Response** `400`
```json
{ ok: false, error: "No spec provided..." }
```

**Response** `400`
```json
{ ok: false, error: "Validation failed", validationErrors: string[] }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/lab/uploads

Delete BDD uploads by their IDs

**Auth**: Session · **Scope**: `lab:write`

**Response** `200`
```json
{ ok: true, deleted: number }
```

**Response** `400`
```json
{ ok: false, error: "No IDs provided" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/lab/uploads

List BDD uploads with optional status filter and limit

**Auth**: Session · **Scope**: `lab:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| limit | query | number | No | Max results (default: 50) |
| status | query | string | No | Filter by upload status |

**Response** `200`
```json
{ ok: true, uploads: BDDUpload[] }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/lab/uploads

Upload one or more BDD files (XML, markdown, text, JSON) via multipart form data

**Auth**: Session · **Scope**: `lab:write`

**Response** `200`
```json
{ ok: true, uploads: BDDUpload[], count: number }
```

**Response** `400`
```json
{ ok: false, error: "No files provided" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/lab/uploads/compile

Compile validated BDD uploads into a Feature Set (creates or updates BDDFeatureSet)

**Auth**: Session · **Scope**: `lab:write`

**Response** `200`
```json
{ ok: true, featureSet: { id, featureId, name, version, parameterCount, constraintCount, definitionCount } }
```

**Response** `400`
```json
{ ok: false, error: "No IDs provided" }
```

**Response** `400`
```json
{ ok: false, error: "No validated uploads found to compile..." }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/lab/uploads/compile-ai

Compile AI-validated BDD uploads into a Feature Set with scoring spec generation

**Auth**: Session · **Scope**: `lab:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| name | body | string | No | Optional override name for the feature set |
| description | body | string | No | Optional override description |
| specType | body | string | No | Optional spec type override |

**Response** `200`
```json
{ ok: true, featureSet: { id, featureId, name, version, ... }, compilationDetails: { ... } }
```

**Response** `400`
```json
{ ok: false, error: "No IDs provided" }
```

**Response** `400`
```json
{ ok: false, error: "No validated uploads found..." }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/lab/uploads/debug

Debug endpoint to list recent BDD uploads with metadata (last 20)

**Auth**: Session · **Scope**: `lab:read`

**Response** `200`
```json
{ ok: true, uploadCount: number, uploads: UploadSummary[] }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Layers

### `GET` /api/layers/diff

Compute the inheritance diff between a base archetype and an overlay identity spec

**Auth**: Session · **Scope**: `layers:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| overlayId | query | string | No | UUID of the overlay (domain) spec |

**Response** `200`
```json
{ ok: true, diff: LayerDiffResult }
```

**Response** `400`
```json
{ ok: false, error: "overlayId required" }
```

**Response** `404`
```json
{ ok: false, error: "Spec not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/layers/specs

List all overlay identity specs grouped by their base archetype

**Auth**: Session · **Scope**: `layers:read`

**Response** `200`
```json
{ ok: true, bases: [...] }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Logs

### `DELETE` /api/logs/ai-calls

Clears the entire log file by deleting it from disk.

**Auth**: Session · **Scope**: `logs:write`

**Response** `200`
```json
{ ok: true }
```

---

### `GET` /api/logs/ai-calls

Returns parsed log entries from the JSONL log file, newest first (max 100). Includes current logging status and enabled log types. Supports filtering by log type.

**Auth**: Session · **Scope**: `logs:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| type | query | string | No | Filter by log type(s), comma-separated: "ai", "api", "system", "user" (optional) |

**Response** `200`
```json
{ logs: [...], loggingEnabled: boolean, enabledTypes: [...] }
```

---

### `PATCH` /api/logs/ai-calls

Toggle logging on/off and/or set which log types are enabled. Both fields are optional and can be set independently.

**Auth**: Session · **Scope**: `logs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| enabled | body | boolean | No | Enable or disable logging (optional) |

**Response** `200`
```json
{ ok: true, loggingEnabled: boolean, enabledTypes: [...] }
```

**Response** `400`
```json
{ ok: false, error: "..." }
```

---

## Manifest

### `GET` /api/manifest

Returns the full manifest with validation status and file metadata

**Auth**: Session · **Scope**: `manifest:read`

**Response** `200`
```json
{ ok: true, manifest, validation, meta: { path, lastModified, size } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/manifest

Perform manifest actions: validate, reload from disk, create backup, or restore from backup

**Auth**: Session · **Scope**: `manifest:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| action | body | string | No | Action to perform: "validate" | "reload" | "backup" | "restore" |
| backupPath | body | string | No | Required for "restore" action: path to backup file |

**Response** `200`
```json
{ ok: true, validation?, message?, backupPath? }
```

**Response** `400`
```json
{ ok: false, error: "backupPath required for restore" }
```

**Response** `400`
```json
{ ok: false, error: "Unknown action: ..." }
```

**Response** `404`
```json
{ ok: false, error: "Backup not found: ..." }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PUT` /api/manifest

Replace the entire manifest file (with optional validation skip)

**Auth**: Session · **Scope**: `manifest:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| manifest | body | object | No | The full manifest object to save |
| skipValidation | body | boolean | No | If true, skip validation before saving |

**Response** `200`
```json
{ ok: true, message: "Manifest saved", validation }
```

**Response** `400`
```json
{ ok: false, error: "manifest object required" }
```

**Response** `400`
```json
{ ok: false, error: "Manifest validation failed", validation }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/manifest/agents

List all agents in the manifest with summary info (settings, schema, prompts, I/O counts)

**Auth**: Session · **Scope**: `manifest:read`

**Response** `200`
```json
{ ok: true, count: number, agents: AgentSummary[] }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/manifest/agents

Add a new agent definition to the manifest

**Auth**: Session · **Scope**: `manifest:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| agent | body | object | No | Agent definition with required id, title, and opid fields |

**Response** `200`
```json
{ ok: true, message: "Agent added to manifest", agent: AgentDefinition }
```

**Response** `400`
```json
{ ok: false, error: "agent object required" }
```

**Response** `400`
```json
{ ok: false, error: "agent.id is required" }
```

**Response** `400`
```json
{ ok: false, error: "agent.title is required" }
```

**Response** `400`
```json
{ ok: false, error: "agent.opid is required" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/manifest/agents/:agentId

Remove an agent from the manifest

**Auth**: Session · **Scope**: `manifest:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| agentId | path | string | Yes | The agent identifier |

**Response** `200`
```json
{ ok: true, message: "Agent removed from manifest", agentId: string }
```

**Response** `404`
```json
{ ok: false, error: "Agent not found: ..." }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/manifest/agents/:agentId

Get a specific agent's full definition from the manifest

**Auth**: Session · **Scope**: `manifest:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| agentId | path | string | Yes | The agent identifier |

**Response** `200`
```json
{ ok: true, agent: AgentDefinition }
```

**Response** `404`
```json
{ ok: false, error: "Agent not found: ..." }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PATCH` /api/manifest/agents/:agentId

Partial update - merge specific fields (settings, schema, prompts, inputs, outputs, etc.)

**Auth**: Session · **Scope**: `manifest:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| agentId | path | string | Yes | The agent identifier |
| settings | body | object | No | Settings to merge |
| settingsSchema | body | object | No | Schema properties to merge |
| prompts | body | object | No | Prompts to merge |
| inputs | body | array | No | Input definitions (replaces) |
| outputs | body | array | No | Output definitions (replaces) |
| title | body | string | No | New title |
| description | body | string | No | New description |
| enabled | body | boolean | No | Enable/disable |
| opid | body | string | No | New operation ID |

**Response** `200`
```json
{ ok: true, message: "Agent patched in manifest", agent: AgentDefinition }
```

**Response** `404`
```json
{ ok: false, error: "Agent not found: ..." }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PUT` /api/manifest/agents/:agentId

Replace an agent's definition in the manifest (cannot change agent ID)

**Auth**: Session · **Scope**: `manifest:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| agentId | path | string | Yes | The agent identifier |
| updates | body | object | No | The updated agent fields |

**Response** `200`
```json
{ ok: true, message: "Agent updated in manifest", agent: AgentDefinition }
```

**Response** `400`
```json
{ ok: false, error: "updates object required" }
```

**Response** `400`
```json
{ ok: false, error: "Cannot change agent ID" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/manifest/sync

Preview sync: compare manifest agents with DB AgentInstances, showing what needs syncing

**Auth**: Session · **Scope**: `manifest:read`

**Response** `200`
```json
{ ok: true, validation, comparison, summary: { total, needsSync, orphaned, outOfSync, synced } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/manifest/sync

Execute sync between manifest and DB: bootstrap new agents, reset to defaults, or cleanup orphans

**Auth**: Session · **Scope**: `manifest:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| action | body | string | No | Sync action: "bootstrap" | "reset" | "cleanup" (default: "bootstrap") |

**Response** `200`
```json
{ ok: true, action, results, summary: { total, created, reset, archived, skipped } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Memories

### `GET` /api/memories

List caller memories with filtering and pagination. By default excludes superseded and expired memories. Supports search across key, value, and evidence fields.

**Auth**: Session · **Scope**: `memories:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | query | string | No | Filter by caller ID (optional) |
| category | query | string | No | Filter by MemoryCategory (FACT | PREFERENCE | EVENT | TOPIC | RELATIONSHIP | CONTEXT) (optional) |
| search | query | string | No | Full-text search across key, value, evidence (optional) |
| includeSuperseded | query | string | No | Include superseded memories ("true" to include, default false) |
| limit | query | number | No | Max results to return (default 100, max 500) |
| offset | query | number | No | Pagination offset (default 0) |

**Response** `200`
```json
{ ok: true, memories: [...], total: number, limit: number, offset: number }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch memories" }
```

---

### `POST` /api/memories

Create a new memory manually for a caller. Handles deduplication: if a memory with the same normalized key exists, it either supersedes the old value or updates confidence if the value matches.

**Auth**: Session · **Scope**: `memories:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | body | string | No | The caller this memory belongs to (required) |
| category | body | string | No | MemoryCategory enum value (required) |
| key | body | string | No | Memory key/label (required) |
| value | body | string | No | Memory value (required) |
| evidence | body | string | No | Supporting evidence text (optional) |
| context | body | string | No | Context in which the memory was captured (optional) |
| confidence | body | number | No | Confidence score 0-1 (default 0.95 for manual entries) |
| expiresInDays | body | number | No | Auto-expire after N days (optional, null = never) |

**Response** `200`
```json
{ ok: true, memory: {...}, supersededId: string|null }
```

**Response** `400`
```json
{ ok: false, error: "callerId is required" }
```

**Response** `404`
```json
{ ok: false, error: "Caller not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to create memory" }
```

---

## Messages

### `GET` /api/messages

List messages for the current user (inbox or sent)

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| type | query | string | No | Message view: "inbox" or "sent" (default: "inbox") |
| limit | query | number | No | Max results (default: 50, max: 100) |
| offset | query | number | No | Pagination offset (default: 0) |
| unreadOnly | query | boolean | No | Only show unread messages (default: false) |

**Response** `200`
```json
{ ok: true, messages: Array, total: number, limit: number, offset: number }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `POST` /api/messages

Send a new message to another user

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| recipientId | body | string | No | Recipient user ID (required) |
| subject | body | string | No | Message subject (optional) |
| content | body | string | No | Message body (required) |
| parentId | body | string | No | Parent message ID for threading (optional) |

**Response** `201`
```json
{ ok: true, message: object }
```

**Response** `400`
```json
{ ok: false, error: "Recipient is required" | "Message content is required" }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `404`
```json
{ ok: false, error: "Recipient not found or inactive" | "Parent message not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `DELETE` /api/messages/:messageId

Delete a message (sender only)

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| messageId | path | string | Yes | The message ID |

**Response** `200`
```json
{ ok: true }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `403`
```json
{ ok: false, error: "Forbidden" }
```

**Response** `404`
```json
{ ok: false, error: "Message not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/messages/:messageId

Get a single message with its thread (parent + replies). Auto-marks as read if recipient is viewing.

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| messageId | path | string | Yes | The message ID |

**Response** `200`
```json
{ ok: true, message: object }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `403`
```json
{ ok: false, error: "Forbidden" }
```

**Response** `404`
```json
{ ok: false, error: "Message not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `PATCH` /api/messages/:messageId

Mark a message as read (recipient only)

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| messageId | path | string | Yes | The message ID |
| readAt | body | string | No | ISO date to mark as read (default: now) |

**Response** `200`
```json
{ ok: true, message: object }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `403`
```json
{ ok: false, error: "Forbidden" }
```

**Response** `404`
```json
{ ok: false, error: "Message not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/messages/unread-count

Get count of unread messages for the current user (for badge display)

**Auth**: Session

**Response** `200`
```json
{ ok: true, count: number }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

## Metering

### `GET` /api/metering/events

Query usage events with optional filters for category, operation, user, caller, and date range

**Auth**: Session · **Scope**: `metering:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| category | query | string | No | Filter by UsageCategory (AI, DATABASE, COMPUTE, STORAGE, EXTERNAL) |
| operation | query | string | No | Filter by operation name (contains match) |
| userId | query | string | No | Filter by user ID |
| callerId | query | string | No | Filter by caller ID |
| limit | query | number | No | Max results (default: 100, max: 1000) |
| offset | query | number | No | Pagination offset (default: 0) |
| since | query | string | No | ISO date string for start of date range |
| until | query | string | No | ISO date string for end of date range |

**Response** `200`
```json
{ ok: true, events: UsageEvent[], pagination: { total, limit, offset, hasMore } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/metering/events

Log a new usage event (primarily for internal use or testing)

**Auth**: Session · **Scope**: `metering:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| category | body | string | No | Usage category (AI, DATABASE, COMPUTE, STORAGE, EXTERNAL) |
| operation | body | string | No | Operation name |
| quantity | body | number | No | Usage quantity |
| unitType | body | string | No | Unit type (e.g. "tokens", "bytes") |
| userId | body | string | No | Optional user ID |
| callerId | body | string | No | Optional caller ID |
| callId | body | string | No | Optional call ID |
| engine | body | string | No | Optional engine name |
| model | body | string | No | Optional model name |
| sourceOp | body | string | No | Optional source operation identifier |
| metadata | body | object | No | Optional metadata |

**Response** `200`
```json
{ ok: true, eventId: string, costCents: number }
```

**Response** `400`
```json
{ ok: false, error: "category and operation are required" }
```

**Response** `400`
```json
{ ok: false, error: "Invalid category..." }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/metering/rates

List all cost rates merged from database entries and defaults

**Auth**: Session · **Scope**: `metering:read`

**Response** `200`
```json
{ ok: true, rates: CostRate[], dbRatesCount: number, defaultRatesCount: number }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/metering/rates

Create or update a cost rate (expires existing rate and creates new one)

**Auth**: Session · **Scope**: `metering:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| category | body | string | No | Usage category (AI, DATABASE, COMPUTE, STORAGE, EXTERNAL) |
| operation | body | string | No | Optional operation name |
| costPerUnit | body | number | No | Cost per unit in cents |
| unitType | body | string | No | Unit type (e.g. "tokens", "bytes") |
| description | body | string | No | Optional description |

**Response** `200`
```json
{ ok: true, rate: UsageCostRate, previousRateExpired: boolean }
```

**Response** `400`
```json
{ ok: false, error: "category, costPerUnit, and unitType are required" }
```

**Response** `400`
```json
{ ok: false, error: "Invalid category..." }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/metering/summary

Returns aggregated usage summary for the metering dashboard including category totals,

**Auth**: Session · **Scope**: `metering:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| days | query | number | No | Number of days to aggregate (default: 30) |

**Response** `200`
```json
{ ok: true, period, totals, today, monthToDate, byCategory, topOperations, dailyTrend, aiByCallPoint, aiByEngine, aiSummary }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/metering/summary/breakdowns

Returns usage breakdowns by caller, domain, most expensive operations, and most used operations

**Auth**: Session · **Scope**: `metering:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| days | query | number | No | Number of days to aggregate (default: 30) |
| limit | query | number | No | Max rows per breakdown (default: 25, max: 100) |

**Response** `200`
```json
{ ok: true, period, byCaller, byDomain, mostExpensive, mostUsed, attribution }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Onboarding

### `GET` /api/onboarding

Fetch onboarding spec data for visualization. Returns persona-specific config including default targets, first-call flow, and welcome templates.

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| persona | query | string | No | Persona slug to load config for (e.g., "tutor", "companion", "coach") |

**Response** `200`
```json
{ ok: true, source: "database" | "hardcoded", spec: object, selectedPersona: string, availablePersonas: string[], personasList: Array, personaName: string, defaultTargets: object, firstCallFlow: object, welcomeTemplate: string }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/onboarding/personas

List all persona onboarding configurations from INIT-001 spec. Falls back to SystemSettings if spec not found.

**Auth**: Session

**Response** `200`
```json
{ ok: true, source: "database" | "fallback", specId?: string, defaultPersona: string, personas: Array<{ slug, name, description, targetCount, phaseCount, hasWelcomeSlug }> }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/onboarding/personas/:slug

Get detailed onboarding configuration for a specific persona including welcome template, default targets, and first-call flow phases

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| slug | path | string | Yes | The persona slug (e.g., "tutor", "companion", "coach") |

**Response** `200`
```json
{ ok: true, specId: string, specSlug: string, persona: { slug, name, description, welcomeTemplate, defaultTargets, firstCallFlow, phaseSlugs } }
```

**Response** `404`
```json
{ ok: false, error: "INIT-001 spec not found" | "Persona not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `PUT` /api/onboarding/personas/:slug

Update onboarding configuration for a specific persona (welcome, targets, flow phases). Also updates associated PromptSlugs.

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| slug | path | string | Yes | The persona slug |
| name | body | string | No | Updated persona name |
| description | body | string | No | Updated description |
| welcomeTemplate | body | string | No | Updated welcome message template |
| defaultTargets | body | object | No | Updated default behavior targets |
| firstCallFlow | body | object | No | Updated first-call flow configuration |

**Response** `200`
```json
{ ok: true, message: string, persona: object }
```

**Response** `404`
```json
{ ok: false, error: "INIT-001 spec not found" | "Persona not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `DELETE` /api/onboarding/personas/manage

Delete a persona from the onboarding spec. Cannot delete the default persona.

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| slug | query | string | No | The persona slug to delete (required) |

**Response** `200`
```json
{ ok: true, message: string }
```

**Response** `400`
```json
{ ok: false, error: "slug query param is required" | "Cannot delete the default persona" }
```

**Response** `404`
```json
{ ok: false, error: "INIT-001 spec not found" | "Persona not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `POST` /api/onboarding/personas/manage

Create a new persona in the onboarding spec with default welcome message and first-call flow

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| slug | body | string | No | Persona slug, lowercase alphanumeric with hyphens (required) |
| name | body | string | No | Persona display name (required) |
| description | body | string | No | Persona description |
| icon | body | string | No | Emoji icon (default: flag in hole) |
| color | body | object | No | Color config { bg, border, text } |

**Response** `200`
```json
{ ok: true, message: string, persona: object }
```

**Response** `400`
```json
{ ok: false, error: "slug and name are required" | "Slug must be lowercase..." | "Persona already exists" }
```

**Response** `404`
```json
{ ok: false, error: "INIT-001 spec not found" }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

## Ops

### `GET` /api/ops

List all available operations with their implementation status

**Auth**: Session · **Scope**: `ops:read`

**Response** `200`
```json
{ ok: true, operations: Array<{ opid, status, description? }> }
```

---

### `POST` /api/ops

Execute an operation by opid. Supports pipeline, transcript, knowledge, analysis, reward loop, and metering operations.

**Auth**: Session · **Scope**: `ops:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| opid | body | string | No | Operation identifier (e.g. "pipeline:run", "transcripts:process", "personality:analyze") |
| settings | body | object | No | Operation-specific settings |
| dryRun | body | boolean | No | If true, plan only without executing (default: false) |

**Response** `200`
```json
{ success: boolean, opid: string, result: object, timestamp: string }
```

**Response** `400`
```json
{ error: "Unknown operation: ..." }
```

**Response** `403`
```json
{ error: "Operations are disabled..." }
```

**Response** `500`
```json
{ error: "..." }
```

**Response** `501`
```json
{ error: "Operation ... not yet implemented" }
```

---

### `GET` /api/ops/:opid

Get operation info. Use opid="_list" to list all available ops with descriptions.

**Auth**: Session · **Scope**: `ops:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| opid | path | string | Yes | Operation identifier or "_list" for listing all ops |

**Response** `200`
```json
{ ok: true, items: Array<{ opid, title, description }> } (when opid="_list")
```

**Response** `405`
```json
{ ok: false, error: "Use POST with includePlan=true for op previews" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/ops/:opid

Execute a specific allow-listed operation by opid (local-only, no shell injection).

**Auth**: Session · **Scope**: `ops:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| opid | path | string | Yes | Operation identifier (e.g. "prisma:migrate:status", "git:status", "kb:build") |
| dryRun | body | boolean | No | If true, return plan without executing (default: false) |
| verbose | body | boolean | No | If true, include detailed events and metadata (default: false) |
| includePlan | body | boolean | No | If true, include structured plan in response (default: false) |

**Response** `200`
```json
{ ok: true, opid, dryRun, startedAt, finishedAt, exitCode, stdout, stderr, plan?, events?, meta? }
```

**Response** `404`
```json
{ ok: false, error: "Unknown op: ..." }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/ops/:opid/parameters

Not supported on collection route - use /api/ops/:opid/parameters/:id instead

**Auth**: Session · **Scope**: `ops:write`

**Response** `405`
```json
{ error: "DELETE not supported on collection route..." }
```

---

### `GET` /api/ops/:opid/parameters

List parameters with pagination, sorting, filtering, and tag support (React Admin compatible).

**Auth**: Session · **Scope**: `ops:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| sort | query | string | No | JSON sort spec: ["field","ASC"] or [["field","ASC"],["field2","DESC"]] |
| range | query | string | No | JSON range: [start, end] (default: [0, 24]) |
| filter | query | string | No | JSON filter: { q?, sectionId?, tags?, tag? } |

**Response** `200`
```json
Parameter[] (with Content-Range header)
```

---

### `PATCH` /api/ops/:opid/parameters

Not supported on collection route - use /api/ops/:opid/parameters/:id instead

**Auth**: Session · **Scope**: `ops:write`

**Response** `405`
```json
{ error: "PATCH not supported on collection route..." }
```

---

### `POST` /api/ops/:opid/parameters

Create a new parameter with optional tag associations

**Auth**: Session · **Scope**: `ops:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| parameterId | body | string | No | Unique parameter identifier |
| name | body | string | No | Parameter display name |
| sectionId | body | string | No | Section identifier |
| domainGroup | body | string | No | Domain group |
| scaleType | body | string | No | Scale type |
| directionality | body | string | No | Directionality |
| computedBy | body | string | No | Computed by method |

**Response** `200`
```json
Parameter (with flattened tags)
```

---

### `DELETE` /api/ops/:opid/parameters/:id

Delete a parameter by parameterId

**Auth**: Session · **Scope**: `ops:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| opid | path | string | Yes | Operation identifier (unused, for route grouping) |
| id | path | string | Yes | Parameter ID (parameterId) |

**Response** `200`
```json
{ ok: true }
```

**Response** `400`
```json
{ error: "Missing id" }
```

**Response** `404`
```json
{ error: "Not found" }
```

**Response** `500`
```json
{ error: "..." }
```

---

### `GET` /api/ops/:opid/parameters/:id

Get a single parameter by parameterId with tags and mappings

**Auth**: Session · **Scope**: `ops:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| opid | path | string | Yes | Operation identifier (unused, for route grouping) |
| id | path | string | Yes | Parameter ID (parameterId) |

**Response** `200`
```json
Parameter (with flattened tags and mappings)
```

**Response** `400`
```json
{ error: "Missing id" }
```

**Response** `404`
```json
{ error: "Not found" }
```

---

### `PATCH` /api/ops/:opid/parameters/:id

Update a parameter's scalar fields and/or tags (partial update with tag reconciliation)

**Auth**: Session · **Scope**: `ops:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| opid | path | string | Yes | Operation identifier (unused, for route grouping) |
| id | path | string | Yes | Parameter ID (parameterId) |
| name | body | string | No | Parameter display name |
| sectionId | body | string | No | Section identifier |
| domainGroup | body | string | No | Domain group |
| definition | body | string | No | Parameter definition text |
| scaleType | body | string | No | Scale type |
| directionality | body | string | No | Directionality |
| computedBy | body | string | No | Computed by method |

**Response** `200`
```json
Parameter (with flattened tags)
```

**Response** `400`
```json
{ error: "Missing id" }
```

**Response** `400`
```json
{ error: "Invalid JSON body" }
```

**Response** `400`
```json
{ error: "tags must be an array of strings" }
```

**Response** `404`
```json
{ error: "Not found" }
```

**Response** `500`
```json
{ error: "..." }
```

---

## Other

### `GET` /api/admin/access-control/entity-access

Load the ENTITY_ACCESS_V1 contract for the access matrix editor

**Auth**: ADMIN

---

### `POST` /api/admin/access-control/entity-access

Update the ENTITY_ACCESS_V1 contract matrix

**Auth**: ADMIN

---

### `POST` /api/admin/access-control/entity-access/reset

Reset the ENTITY_ACCESS_V1 contract to its seed default

**Auth**: SUPERADMIN

---

### `GET` /api/admin/access-control/sidebar-visibility

Load sidebar visibility rules (DB-backed, falls back to manifest)

**Auth**: ADMIN

---

### `POST` /api/admin/access-control/sidebar-visibility

Save sidebar visibility rules

**Auth**: ADMIN

---

### `GET` /api/institution/branding

Get branding for the current user's institution.

**Auth**: VIEWER (any authenticated user)

---

### `GET` /api/institutions

List all institutions with user/cohort counts.

**Auth**: SUPERADMIN

---

### `POST` /api/institutions

Create a new institution.

**Auth**: SUPERADMIN

---

### `DELETE` /api/institutions/[id]

Soft-delete an institution (sets isActive = false).

**Auth**: SUPERADMIN

---

### `GET` /api/institutions/[id]

Get a single institution by ID.

**Auth**: SUPERADMIN

---

### `PATCH` /api/institutions/[id]

Update institution fields (name, branding, active status).

**Auth**: SUPERADMIN

---

### `GET` /api/join/[token]

Verify a classroom join token. Returns classroom info if valid.

**Auth**: None

---

### `POST` /api/join/[token]

Accept a classroom join link. Creates User + Caller + sets session.

**Auth**: None

---

### `GET` /api/student/calls

**Auth**: STUDENT

---

### `GET` /api/student/calls/:callId

**Auth**: STUDENT

---

### `GET` /api/student/progress

**Auth**: STUDENT

---

### `GET` /api/student/teacher

**Auth**: STUDENT

---

## Parameters

### `GET` /api/parameters

List parameters with React-Admin compatible pagination, sorting, and filtering. Includes tags, prompt slug links, and source feature set.

**Auth**: Session · **Scope**: `parameters:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| sort | query | string | No | JSON array [field, order] e.g. ["parameterId", "ASC"] |
| range | query | string | No | JSON array [start, end] e.g. [0, 24] |
| filter | query | string | No | JSON object e.g. {"q": "search term", "isActive": true, "parameterType": "BEHAVIOR"} |

**Response** `200`
```json
Parameter[] (with Content-Range header for pagination)
```

**Response** `500`
```json
{ error: "..." }
```

---

### `POST` /api/parameters

Create a new parameter (React-Admin compatible)

**Auth**: Session · **Scope**: `parameters:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| parameterId | body | string | No | Unique semantic parameter ID (e.g. "B5-O", "VARK-V") |
| name | body | string | No | Display name |
| domainGroup | body | string | No | Domain group |
| sectionId | body | string | No | Section ID |
| scaleType | body | string | No | Scale type |
| directionality | body | string | No | Directionality |
| computedBy | body | string | No | Computed by |
| definition | body | string | No | Parameter definition |
| interpretationLow | body | string | No | Low-score interpretation |
| interpretationHigh | body | string | No | High-score interpretation |

**Response** `201`
```json
Parameter
```

**Response** `500`
```json
{ error: "..." }
```

---

### `DELETE` /api/parameters/:id

Delete a parameter permanently (React-Admin compatible)

**Auth**: Session · **Scope**: `parameters:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID |

**Response** `200`
```json
Parameter (the deleted record)
```

**Response** `500`
```json
{ error: "..." }
```

---

### `GET` /api/parameters/:id

Get a single parameter by UUID with tags and prompt slug links (React-Admin compatible)

**Auth**: Session · **Scope**: `parameters:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID |

**Response** `200`
```json
Parameter
```

**Response** `404`
```json
{ error: "Parameter not found" }
```

**Response** `500`
```json
{ error: "..." }
```

---

### `PUT` /api/parameters/:id

Update a parameter's fields (React-Admin compatible). parameterId is immutable.

**Auth**: Session · **Scope**: `parameters:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID |
| name | body | string | No | Display name |
| domainGroup | body | string | No | Domain group |
| sectionId | body | string | No | Section ID |
| scaleType | body | string | No | Scale type |
| directionality | body | string | No | Directionality |
| computedBy | body | string | No | Computed by |
| definition | body | string | No | Parameter definition |
| interpretationLow | body | string | No | Low-score interpretation |
| interpretationHigh | body | string | No | High-score interpretation |

**Response** `200`
```json
Parameter
```

**Response** `500`
```json
{ error: "..." }
```

---

### `DELETE` /api/parameters/:id/anchors

Delete scoring anchors by IDs

**Auth**: Session · **Scope**: `parameters:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID or parameterId |

**Response** `200`
```json
{ ok: true, deleted: number }
```

**Response** `400`
```json
{ ok: false, error: "ids array required" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/parameters/:id/anchors

Get all scoring anchors for a parameter, ordered by score and sort order

**Auth**: Session · **Scope**: `parameters:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID or parameterId |

**Response** `200`
```json
{ ok: true, parameter: { id, parameterId, name, scaleType, interpretationHigh, interpretationLow }, anchors: ScoringAnchor[], count: number }
```

**Response** `404`
```json
{ ok: false, error: "Parameter not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/parameters/:id/anchors

Add a scoring anchor to a parameter

**Auth**: Session · **Scope**: `parameters:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID or parameterId |
| example | body | string | No | The transcript excerpt or synthetic example (required) |
| score | body | number | No | The calibrated score, typically 0-1 (required) |
| rationale | body | string | No | Why this score |
| isGold | body | boolean | No | Is this a canonical example (default: false) |
| source | body | string | No | Where this anchor came from |

**Response** `200`
```json
{ ok: true, anchor: ScoringAnchor }
```

**Response** `400`
```json
{ ok: false, error: "example and score are required" }
```

**Response** `404`
```json
{ ok: false, error: "Parameter not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PUT` /api/parameters/:id/anchors

Bulk update scoring anchors (reorder or batch edit)

**Auth**: Session · **Scope**: `parameters:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID or parameterId |
| anchors | body | Array | No | Array of anchor updates: [{id: string, example?, score?, rationale?, positiveSignals?, negativeSignals?, isGold?, sortOrder?}] |

**Response** `200`
```json
{ ok: true, updated: number }
```

**Response** `400`
```json
{ ok: false, error: "anchors array required" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/parameters/:id/enrich

Get current enrichment status for a parameter (enriched high/low, enrichment date, chunk IDs)

**Auth**: Session · **Scope**: `parameters:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID or parameterId |

**Response** `200`
```json
{ ok: true, parameter: Parameter, isEnriched: boolean }
```

**Response** `404`
```json
{ ok: false, error: "Parameter not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/parameters/:id/enrich

AI-powered enrichment of a parameter's high/low interpretations. Searches knowledge base chunks and uses Claude to expand definitions with deeper behavioral context.

**Auth**: Session · **Scope**: `parameters:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID or parameterId |
| model | body | string | No | Claude model (default: claude-3-haiku-20240307) |
| dryRun | body | boolean | No | If true, returns enrichment without saving (default: false) |

**Response** `200`
```json
{ ok: true, parameterId, name, original: { interpretationHigh, interpretationLow }, enriched: { enrichedHigh, enrichedLow }, chunksUsed: [], usage: { inputTokens, outputTokens }, saved: boolean }
```

**Response** `404`
```json
{ ok: false, error: "Parameter not found" }
```

**Response** `500`
```json
{ ok: false, error: "ANTHROPIC_API_KEY not configured" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/parameters/:id/prompts

Detach a dynamic prompt slug from this parameter

**Auth**: Session · **Scope**: `parameters:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID |
| slugId | query | string | No | The prompt slug UUID to detach (required) |

**Response** `200`
```json
{ ok: true, deleted: true }
```

**Response** `400`
```json
{ ok: false, error: "slugId query param is required" }
```

**Response** `404`
```json
{ ok: false, error: "Parameter not found" }
```

**Response** `404`
```json
{ ok: false, error: "Link not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/parameters/:id/prompts

Get all dynamic prompt slugs linked to this parameter, plus available slugs that could be linked

**Auth**: Session · **Scope**: `parameters:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID |

**Response** `200`
```json
{ ok: true, links: PromptSlugParameter[], availableSlugs: PromptSlug[] }
```

**Response** `404`
```json
{ ok: false, error: "Parameter not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PATCH` /api/parameters/:id/prompts

Update a prompt-parameter link's weight or mode

**Auth**: Session · **Scope**: `parameters:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID |
| slugId | body | string | No | The prompt slug UUID to update (required) |
| weight | body | number | No | Updated link weight |
| mode | body | string | No | "ABSOLUTE" or "DELTA" |

**Response** `200`
```json
{ ok: true, link: PromptSlugParameter }
```

**Response** `400`
```json
{ ok: false, error: "slugId is required" }
```

**Response** `404`
```json
{ ok: false, error: "Parameter not found" }
```

**Response** `404`
```json
{ ok: false, error: "Link not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/parameters/:id/prompts

Attach a dynamic prompt slug to this parameter

**Auth**: Session · **Scope**: `parameters:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID |
| slugId | body | string | No | The prompt slug UUID to attach (required) |
| weight | body | number | No | Link weight (default: 1.0) |
| mode | body | string | No | "ABSOLUTE" or "DELTA" (default: "ABSOLUTE") |

**Response** `200`
```json
{ ok: true, link: PromptSlugParameter }
```

**Response** `400`
```json
{ ok: false, error: "slugId is required" }
```

**Response** `400`
```json
{ ok: false, error: "This dynamic prompt is already attached..." }
```

**Response** `404`
```json
{ ok: false, error: "Parameter not found" }
```

**Response** `404`
```json
{ ok: false, error: "Dynamic prompt not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/parameters/:id/tags

Remove a tag from a parameter

**Auth**: Session · **Scope**: `parameters:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID |
| tagName | query | string | No | Tag name to remove (required) |

**Response** `200`
```json
Parameter (with updated tags)
```

**Response** `400`
```json
{ error: "tagName query parameter is required" }
```

**Response** `404`
```json
{ error: "Parameter not found" }
```

**Response** `404`
```json
{ error: "Tag not found" }
```

**Response** `500`
```json
{ error: "..." }
```

---

### `POST` /api/parameters/:id/tags

Add a tag to a parameter. Creates the tag if it does not exist. Idempotent (no error if link already exists).

**Auth**: Session · **Scope**: `parameters:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Parameter UUID |
| tagName | body | string | No | Tag name to add (required) |

**Response** `200`
```json
Parameter (with updated tags)
```

**Response** `400`
```json
{ error: "tagName is required" }
```

**Response** `404`
```json
{ error: "Parameter not found" }
```

**Response** `500`
```json
{ error: "..." }
```

---

### `GET` /api/parameters/display-config

Returns parameter display configuration for UI rendering. Dynamically groups canonical parameters (Big Five, VARK, Other) with labels, colors, and section metadata. No hardcoding.

**Auth**: Session · **Scope**: `parameters:read`

**Response** `200`
```json
{ ok: true, grouped: { "Big Five": [], "VARK": [], "Other": [] }, params: Record<string, ParamDisplayInfo>, totalParameters: number }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/parameters/export

Export all parameters as a downloadable CSV file with tags (pipe-delimited) and slug links (pipe-delimited slugSlug:weight:mode)

**Auth**: Session · **Scope**: `parameters:read`

**Response** `200`
```json
text/csv (Content-Disposition: attachment; filename="parameters-export-YYYY-MM-DD.csv")
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Pipeline

### `GET` /api/pipeline/manifest

Get the pipeline blueprint/manifest defining all pipeline stages and operations

**Auth**: Session · **Scope**: `pipeline:read`

**Response** `200`
```json
{ ok: true, manifest: PipelineManifest }
```

---

### `GET` /api/pipeline/runs

List pipeline runs derived from ComposedPrompt records. Each run includes

**Auth**: Session · **Scope**: `pipeline:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | query | string | No | Filter runs by caller ID |
| limit | query | number | No | Max results (default 20) |
| offset | query | number | No | Pagination offset (default 0) |

**Response** `200`
```json
{ ok: true, runs: PipelineRun[], total: number, limit: number, offset: number }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch pipeline runs" }
```

---

### `GET` /api/pipeline/runs/:runId

Get full details for a single pipeline run including all steps

**Auth**: Session · **Scope**: `pipeline:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| runId | path | string | Yes | Pipeline run UUID |

**Response** `200`
```json
{ ok: true, run: PipelineRun }
```

**Response** `404`
```json
{ ok: false, error: "Pipeline run not found" }
```

**Response** `500`
```json
{ ok: false, error: "Failed to fetch pipeline run" }
```

---

### `GET` /api/pipeline/stages

Returns pipeline stage configuration for visualization and documentation.

**Auth**: Session · **Scope**: `pipeline:read`

**Response** `200`
```json
{ ok: true, stages: PipelineStage[], count: number }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Playbooks

### `GET` /api/playbooks

List all playbooks with optional domain and status filters

**Auth**: Session · **Scope**: `playbooks:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | query | string | No | Filter playbooks by domain ID |
| status | query | string | No | Filter playbooks by status (DRAFT, PUBLISHED, ARCHIVED) |

**Response** `200`
```json
{ ok: true, playbooks: Playbook[], count: number }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/playbooks

Create a new playbook in DRAFT status

**Auth**: Session · **Scope**: `playbooks:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| name | body | string | No | Playbook name (required) |
| description | body | string | No | Playbook description |
| domainId | body | string | No | Domain ID to associate (required) |

**Response** `200`
```json
{ ok: true, playbook: Playbook }
```

**Response** `400`
```json
{ ok: false, error: "name and domainId are required" }
```

**Response** `404`
```json
{ ok: false, error: "Domain not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/playbooks/:playbookId

Delete a draft playbook and its items. Published playbooks cannot be deleted.

**Auth**: Session · **Scope**: `playbooks:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| playbookId | path | string | Yes | Playbook UUID |

**Response** `200`
```json
{ ok: true, message: "Playbook deleted" }
```

**Response** `400`
```json
{ ok: false, error: "Cannot delete a published playbook. Archive it instead." }
```

**Response** `404`
```json
{ ok: false, error: "Playbook not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/playbooks/:playbookId

Get playbook details with all items, domain, system specs, and parent version

**Auth**: Session · **Scope**: `playbooks:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| playbookId | path | string | Yes | Playbook UUID |

**Response** `200`
```json
{ ok: true, playbook: Playbook }
```

**Response** `404`
```json
{ ok: false, error: "Playbook not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PATCH` /api/playbooks/:playbookId

Update playbook metadata, items, system spec toggles, status, or config settings

**Auth**: Session · **Scope**: `playbooks:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| playbookId | path | string | Yes | Playbook UUID |
| name | body | string | No | Updated playbook name |
| description | body | string | No | Updated description |
| items | body | Array | No | Replacement items array (for DRAFT playbooks) |
| specs | body | Array | No | System spec toggles array |
| toggleSpec | body | object | No | Single spec toggle { specId, enabled } |
| agentId | body | string | No | Agent ID reference |
| sortOrder | body | number | No | Domain-level sort order |
| domainId | body | string | No | Reassign to another domain |
| status | body | string | No | Status transition (DRAFT, ARCHIVED) |
| configSettings | body | object | No | Config settings (memory, learning, AI, thresholds) |

**Response** `200`
```json
{ ok: true, playbook: Playbook }
```

**Response** `400`
```json
{ ok: false, error: "..." }
```

**Response** `404`
```json
{ ok: false, error: "Playbook not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/playbooks/:playbookId/compile-targets

Compiles the playbook's behavior targets by scanning all enabled specs,

**Auth**: Session · **Scope**: `playbooks:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| playbookId | path | string | Yes | Playbook UUID |

**Response** `200`
```json
{ ok: true, message: "...", compiled: number, skipped: number, total: number, parameters: [...] }
```

**Response** `400`
```json
{ ok: false, error: "Cannot compile targets for a published playbook" }
```

**Response** `404`
```json
{ ok: false, error: "Playbook not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/playbooks/:playbookId/new-version

Clones a published playbook as a new DRAFT version. Copies all items and

**Auth**: Session · **Scope**: `playbooks:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| playbookId | path | string | Yes | Source playbook UUID (must be PUBLISHED) |

**Response** `200`
```json
{ ok: true, playbook: Playbook, message: "...", copiedItems: number, copiedTargets: number }
```

**Response** `400`
```json
{ ok: false, error: "Can only create new version from a PUBLISHED playbook" }
```

**Response** `404`
```json
{ ok: false, error: "Playbook not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/playbooks/:playbookId/parameters

Returns all parameters used by specs in this playbook, organized by category

**Auth**: Session · **Scope**: `playbooks:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| playbookId | path | string | Yes | Playbook UUID |

**Response** `200`
```json
{ ok: true, playbook: { id, name, status }, categories: ParametersByCategory[], counts: { parameters, anchors, categories } }
```

**Response** `404`
```json
{ ok: false, error: "Playbook not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/playbooks/:playbookId/publish

Validates and publishes a playbook. Runs validation checks (items exist,

**Auth**: Session · **Scope**: `playbooks:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| playbookId | path | string | Yes | Playbook UUID (must be DRAFT) |

**Response** `200`
```json
{ ok: true, playbook: Playbook, validationErrors: [...], validationPassed: true, stats: {...} }
```

**Response** `400`
```json
{ ok: false, error: "Playbook is already published" }
```

**Response** `404`
```json
{ ok: false, error: "Playbook not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/playbooks/:playbookId/slugs

Returns a structured tree of all template variables/slugs available in this

**Auth**: Session · **Scope**: `playbooks:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| playbookId | path | string | Yes | Playbook UUID |

**Response** `200`
```json
{ ok: true, playbook: { id, name, status }, tree: SlugNode[], counts: { identity, content, voice, measure, learn, adapt, reward, guardrail, compose, total } }
```

**Response** `404`
```json
{ ok: false, error: "Playbook not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/playbooks/:playbookId/targets

Returns all adjustable BEHAVIOR parameters with their cascade of targets

**Auth**: Session · **Scope**: `playbooks:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| playbookId | path | string | Yes | Playbook UUID |

**Response** `200`
```json
{ ok: true, playbookId, playbookName, playbookStatus, parameters: [...], counts: { total, withPlaybookOverride, withSystemDefault } }
```

**Response** `404`
```json
{ ok: false, error: "Playbook not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PATCH` /api/playbooks/:playbookId/targets

Update playbook-level behavior targets. Set targetValue to null to remove

**Auth**: Session · **Scope**: `playbooks:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| playbookId | path | string | Yes | Playbook UUID (must not be PUBLISHED) |

**Response** `200`
```json
{ ok: true, results: [...], message: "Updated N targets" }
```

**Response** `400`
```json
{ ok: false, error: "targets must be an array" }
```

**Response** `400`
```json
{ ok: false, error: "Cannot modify targets for a published playbook" }
```

**Response** `404`
```json
{ ok: false, error: "Playbook not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/playbooks/:playbookId/tree

Returns a hierarchical tree structure of the playbook including domain,

**Auth**: Session · **Scope**: `playbooks:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| playbookId | path | string | Yes | Playbook UUID |

**Response** `200`
```json
{ ok: true, tree: TreeNode, stats: { totalItems, specCount, templateCount, systemSpecCount, systemSpecEnabledCount, parameterCount, targetCount } }
```

**Response** `404`
```json
{ ok: false, error: "Playbook not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/playbooks/:playbookId/triggers

Returns all triggers and actions across all specs in this playbook,

**Auth**: Session · **Scope**: `playbooks:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| playbookId | path | string | Yes | Playbook UUID |

**Response** `200`
```json
{ ok: true, playbook: { id, name, status }, categories: TriggersByOutputType[], counts: { specs, triggers, actions, outputTypes } }
```

**Response** `404`
```json
{ ok: false, error: "Playbook not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/playbooks/available-items

Get all active specs (by scope) and prompt templates available for building playbooks

**Auth**: Session · **Scope**: `playbooks:read`

**Response** `200`
```json
{ ok: true, callerSpecs: [], domainSpecs: AnalysisSpec[], systemSpecs: AnalysisSpec[], promptTemplates: PromptTemplate[], counts: {...} }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Prompts

### `GET` /api/prompt-blocks

List all prompt blocks with optional category and active status filtering

**Auth**: Session · **Scope**: `prompts:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| category | query | string | No | Filter by block category |
| isActive | query | string | No | Filter by active status ("true" or "false") |

**Response** `200`
```json
{ ok: true, blocks: PromptBlock[], categories: [...] }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/prompt-blocks

Create a new prompt block with slug, name, category, and content

**Auth**: Session · **Scope**: `prompts:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| slug | body | string | No | Unique slug identifier (required) |
| name | body | string | No | Display name (required) |
| description | body | string | No | Block description |
| category | body | string | No | Block category (required) |
| content | body | string | No | Block content text (required) |
| isActive | body | boolean | No | Active status (default true) |

**Response** `201`
```json
{ ok: true, block: PromptBlock }
```

**Response** `400`
```json
{ ok: false, error: "Missing required fields: slug, name, category, content" }
```

**Response** `409`
```json
{ ok: false, error: "Block with slug '...' already exists" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/prompt-blocks/:id

Delete a prompt block. Fails if the block is used in any stacks.

**Auth**: Session · **Scope**: `prompts:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Prompt block UUID or slug |

**Response** `200`
```json
{ ok: true, deleted: true }
```

**Response** `400`
```json
{ ok: false, error: "Cannot delete block used in N stack(s)..." }
```

**Response** `404`
```json
{ ok: false, error: "Prompt block not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/prompt-blocks/:id

Get a single prompt block by ID or slug, including stacks it is used in

**Auth**: Session · **Scope**: `prompts:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Prompt block UUID or slug |

**Response** `200`
```json
{ ok: true, block: PromptBlock }
```

**Response** `404`
```json
{ ok: false, error: "Prompt block not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PATCH` /api/prompt-blocks/:id

Update a prompt block's name, description, category, content, or active status

**Auth**: Session · **Scope**: `prompts:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Prompt block UUID or slug |
| name | body | string | No | Updated name |
| description | body | string | No | Updated description |
| category | body | string | No | Updated category |
| content | body | string | No | Updated content |
| isActive | body | boolean | No | Updated active status |

**Response** `200`
```json
{ ok: true, block: PromptBlock }
```

**Response** `404`
```json
{ ok: false, error: "Prompt block not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/prompt-slugs

List all prompt slugs (dynamic prompts) with optional filtering by source type,

**Auth**: Session · **Scope**: `prompts:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| sourceType | query | string | No | Filter by source type (PARAMETER, COMPOSITE, MEMORY, etc.) |
| parameterId | query | string | No | Filter slugs linked to a specific parameter |
| isActive | query | string | No | Filter by active status ("true" or "false") |

**Response** `200`
```json
{ ok: true, slugs: PromptSlug[], parameters: Parameter[] }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/prompt-slugs

Create a new prompt slug (dynamic prompt) with parameters and value ranges.

**Auth**: Session · **Scope**: `prompts:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| slug | body | string | No | Unique slug identifier (required) |
| name | body | string | No | Display name (required) |
| description | body | string | No | Slug description |
| sourceType | body | string | No | Source type: PARAMETER, COMPOSITE, MEMORY, etc. (required) |
| parameterId | body | string | No | Legacy single parameter ID |
| mode | body | string | No | Legacy parameter mode |
| memoryCategory | body | string | No | Memory category (required for MEMORY source type) |
| memoryMode | body | string | No | Memory retrieval mode (default "latest") |
| fallbackPrompt | body | string | No | Fallback prompt text |
| priority | body | number | No | Priority ordering (default 0) |
| isActive | body | boolean | No | Active status (default true) |

**Response** `201`
```json
{ ok: true, slug: PromptSlug }
```

**Response** `400`
```json
{ ok: false, error: "..." }
```

**Response** `409`
```json
{ ok: false, error: "Slug '...' already exists" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/prompt-slugs/:id

Delete a dynamic prompt and its parameter links/ranges. Fails if used in any stacks.

**Auth**: Session · **Scope**: `prompts:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Prompt slug UUID or slug string |

**Response** `200`
```json
{ ok: true, deleted: true }
```

**Response** `400`
```json
{ ok: false, error: "Cannot delete dynamic prompt used in N stack(s)..." }
```

**Response** `404`
```json
{ ok: false, error: "Dynamic prompt not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/prompt-slugs/:id

Get a single dynamic prompt by ID or slug with all parameters, ranges, and stack usage

**Auth**: Session · **Scope**: `prompts:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Prompt slug UUID or slug string |

**Response** `200`
```json
{ ok: true, slug: PromptSlug }
```

**Response** `404`
```json
{ ok: false, error: "Dynamic prompt not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PATCH` /api/prompt-slugs/:id

Update a dynamic prompt, its parameters, and ranges. Replaces parameter

**Auth**: Session · **Scope**: `prompts:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | path | string | Yes | Prompt slug UUID or slug string |
| name | body | string | No | Updated name |
| description | body | string | No | Updated description |
| sourceType | body | string | No | Updated source type |
| parameterId | body | string | No | Legacy single parameter ID |
| mode | body | string | No | Legacy parameter mode |
| memoryCategory | body | string | No | Updated memory category |
| memoryMode | body | string | No | Updated memory mode |
| fallbackPrompt | body | string | No | Updated fallback prompt |
| priority | body | number | No | Updated priority |
| isActive | body | boolean | No | Updated active status |

**Response** `200`
```json
{ ok: true, slug: PromptSlug }
```

**Response** `404`
```json
{ ok: false, error: "Dynamic prompt not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/prompt-templates

List all prompt templates with optional inactive inclusion

**Auth**: Session · **Scope**: `prompts:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| includeInactive | query | string | No | Include inactive templates ("true") |

**Response** `200`
```json
{ ok: true, templates: PromptTemplate[], count: number }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/prompt-templates

Create a new prompt template with system prompt and optional modifiers

**Auth**: Session · **Scope**: `prompts:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| slug | body | string | No | Unique slug identifier (required) |
| name | body | string | No | Display name (required) |
| description | body | string | No | Template description |
| systemPrompt | body | string | No | System prompt content (required) |
| personalityModifiers | body | string | No | Personality modifier template |
| contextTemplate | body | string | No | Context template |

**Response** `200`
```json
{ ok: true, template: PromptTemplate }
```

**Response** `400`
```json
{ ok: false, error: "slug, name, and systemPrompt are required" }
```

**Response** `409`
```json
{ ok: false, error: "Template with slug \"...\" already exists" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/prompt/compose-from-specs

Quick spec-based prompt composition for a caller by ID or identity ID.

**Auth**: Session · **Scope**: `prompts:compose`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | query | string | No | Caller UUID |
| callerIdentityId | query | string | No | Caller identity UUID |
| domain | query | string | No | Filter specs by domain |
| outputType | query | string | No | Filter specs by output type (MEASURE, LEARN) |

**Response** `200`
```json
{ ok: true, prompt: string, promptCount: number, specCount: number, memoryCount: number }
```

**Response** `400`
```json
{ ok: false, error: "Must provide callerId or callerIdentityId" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/prompt/compose-from-specs

Spec-based prompt composition. Gathers all active AnalysisSpecs with

**Auth**: Session · **Scope**: `prompts:compose`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | body | string | No | Fetch caller's parameter values and memories |
| callerIdentityId | body | string | No | Fetch caller identity's latest values |
| includeMemories | body | boolean | No | Include caller memories in composition (default true) |
| domain | body | string | No | Filter specs by domain |
| outputType | body | string | No | Filter specs by output type (MEASURE, LEARN) |

**Response** `200`
```json
{ ok: true, prompt: string, prompts: [...], metadata: { totalSpecs, specsWithTemplates, promptsRendered, memoriesIncluded, composedAt, parameterValuesUsed } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/prompt/post-call

Get the current state and next prompt for a caller. Useful for previewing

**Auth**: Session · **Scope**: `prompts:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | query | string | No | Caller identity ID (required) |

**Response** `200`
```json
{ ok: true, callerIdentity: {...}, state: { hasProfile, parameterCount, memoryCount, parameterValues }, prompt: { text, length, specsUsed, totalActiveSpecs, specs } }
```

**Response** `400`
```json
{ ok: false, error: "callerId query parameter required" }
```

**Response** `404`
```json
{ ok: false, error: "Caller identity not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/prompt/post-call

Post-call pipeline endpoint that orchestrates call analysis. Receives call

**Auth**: Session · **Scope**: `pipeline:execute`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | body | string | No | The caller identifier (required) |
| transcript | body | string | No | Raw transcript text |
| transcriptId | body | string | No | ID of existing transcript record |
| analysisResults | body | object | No | Pre-computed analysis results { parameterValues, memories } |
| runAnalysis | body | boolean | No | Whether to trigger analysis (default false) |
| composePrompt | body | boolean | No | Whether to compose next prompt (default true) |

**Response** `200`
```json
{ ok: true/false, pipeline: PipelineResult, prompt: string | null, nextCall: { callerIdentityId, callerId, hasPrompt, promptLength } }
```

**Response** `400`
```json
{ ok: false, error: "callerId is required" }
```

**Response** `500`
```json
{ ok: false, error: "Pipeline failed" }
```

---

## Settings

### `DELETE` /api/system-settings

Delete a system setting by key, reverting to code default.

**Auth**: Session · **Scope**: `settings:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| key | query | string | No | The setting key to delete |

**Response** `200`
```json
{ ok: true }
```

**Response** `400`
```json
{ ok: false, error: string }
```

**Response** `404`
```json
{ ok: false, error: string }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `GET` /api/system-settings

List all system settings as key-value pairs.

**Auth**: Session · **Scope**: `settings:read`

**Response** `200`
```json
{ ok: true, settings: [...] }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

### `POST` /api/system-settings

Create or update a system setting. Value is auto-serialised to JSON.

**Auth**: Session · **Scope**: `settings:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| key | body | string | No | Dot-notation key (e.g. "pipeline.min_transcript_words") |
| value | body | any | No | The setting value (number, string, boolean, object) |

**Response** `200`
```json
{ ok: true, setting: {...} }
```

**Response** `400`
```json
{ ok: false, error: string }
```

**Response** `500`
```json
{ ok: false, error: string }
```

---

## Sidebar

### `DELETE` /api/sidebar-layout/personal

Clears the current user's personal sidebar layout preference, reverting to defaults.

**Auth**: Session · **Scope**: `sidebar:delete`

**Response** `200`
```json
{ success: true }
```

**Response** `401`
```json
{ error: "Unauthorized" }
```

---

### `GET` /api/sidebar-layout/personal

Loads the current user's personal sidebar layout preference from system settings.

**Auth**: Session · **Scope**: `sidebar:read`

**Response** `200`
```json
{ layout: SidebarLayout | null }
```

**Response** `401`
```json
{ error: "Unauthorized" }
```

---

### `POST` /api/sidebar-layout/personal

Saves the current user's personal sidebar layout preference. Creates or updates the system setting.

**Auth**: Session · **Scope**: `sidebar:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| layout | body | SidebarLayout | No | The sidebar layout configuration to save |

**Response** `200`
```json
{ success: true }
```

**Response** `400`
```json
{ error: "Invalid layout format" }
```

**Response** `401`
```json
{ error: "Unauthorized" }
```

**Response** `500`
```json
{ error: "Failed to save layout" }
```

---

## Sim

### `GET` /api/sim/conversations

Returns callers with their last call message preview for the chat list UI. Session-authenticated OPERATORs see only their own callers; ADMINs and sim-token users see all.

**Auth**: Session

**Response** `200`
```json
{ ok: true, conversations: Array<{ callerId, name, domain, lastMessage, lastMessageAt, createdAt }>, needsSetup?: boolean }
```

**Response** `500`
```json
{ ok: false, error: "Failed to load conversations" }
```

---

### `POST` /api/sim/setup

Creates a Caller record linked to the authenticated user in the specified domain. Used on first sim access.

**Auth**: Session

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | body | string | No | Domain to create caller in (required) |

**Response** `200`
```json
{ ok: true, caller: { id, name, domainId } }
```

**Response** `400`
```json
{ ok: false, error: "..." }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

---

### `GET` /api/sim/setup-info

Returns setup info for a new sim tester: whether they have an assigned domain (from invite) or need to choose one.

**Auth**: Session

**Response** `200`
```json
{ ok: true, user, assignedDomainId?, assignedDomainName?, domains? }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

---

## Specs

### `GET` /api/specs

List analysis specs with optional filtering by spec role

**Auth**: Session · **Scope**: `specs:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| role | query | string | No | Filter by specRole (e.g. EXTRACT, SYNTHESISE, CONSTRAIN) |

**Response** `200`
```json
{ ok: true, specs: AnalysisSpec[], count: number }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/specs/:specId

Delete a spec permanently

**Auth**: Session · **Scope**: `specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID |

**Response** `200`
```json
{ ok: true }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/specs/:specId

Get a single spec by ID with triggers, actions, parameters, and prompt slug data

**Auth**: Session · **Scope**: `specs:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID |

**Response** `200`
```json
{ ok: true, spec: AnalysisSpec }
```

**Response** `404`
```json
{ ok: false, error: "Spec not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PATCH` /api/specs/:specId

Update a spec's metadata (name, description, isActive, isDirty, priority, config, promptTemplate)

**Auth**: Session · **Scope**: `specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| specId | path | string | Yes | Spec UUID |
| name | body | string | No | Updated display name |
| description | body | string | No | Updated description |
| isActive | body | boolean | No | Enable or disable spec |
| isDirty | body | boolean | No | Mark spec as dirty |
| priority | body | number | No | Spec priority |
| config | body | object | No | Spec configuration |
| promptTemplate | body | string | No | Prompt template text |

**Response** `200`
```json
{ ok: true, spec: AnalysisSpec }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/specs/assistant

AI assistant for spec creation. Provides conversational help filling in spec fields, suggests values, and returns structured JSON field updates to auto-populate the form.

**Auth**: Session · **Scope**: `specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| message | body | string | No | The user's message |
| currentSpec | body | object | No | The current spec form state |
| history | body | Array | No | Conversation history: [{role: 'user'|'assistant', content: string}] |

**Response** `200`
```json
{ ok: true, response: string, fieldUpdates: object|null }
```

**Response** `400`
```json
{ ok: false, error: "message is required" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/specs/assistant-view

AI assistant for understanding, modifying, and troubleshooting existing specs. Provides explanations, improvement suggestions, and structured edit suggestions.

**Auth**: Session · **Scope**: `specs:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| message | body | string | No | The user's message |
| context | body | object | No | The current spec being viewed: { type: string, data: AnalysisSpec } |
| history | body | Array | No | Conversation history: [{role: 'user'|'assistant', content: string}] |

**Response** `200`
```json
{ ok: true, response: string, suggestions: object|null }
```

**Response** `400`
```json
{ ok: false, error: "message is required" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/specs/create

Create a new BDD spec from JSON body, write to docs-archive/bdd-specs/ file, and optionally auto-activate

**Auth**: Session · **Scope**: `specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| spec | body | SpecFormData | No | The spec form data (id, title, version, domain, specType, specRole, outputType, story, parameters, etc.) |
| autoActivate | body | boolean | No | Whether to activate after creation (default: true) |

**Response** `200`
```json
{ ok: true, specId: string, featureSetId: string, featureId: string, activated: boolean, fileWritten: string|null }
```

**Response** `400`
```json
{ ok: false, error: "ID is required" }
```

**Response** `409`
```json
{ ok: false, error: "A spec with ID ... already exists" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/specs/extract-structure

AI-powered structure extraction. Converts raw document text into a structured BDD spec JSON using type-specific prompts (CURRICULUM, MEASURE, IDENTITY, etc.).

**Auth**: Session · **Scope**: `specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| rawText | body | string | No | The raw document text to extract structure from |
| specType | body | string | No | The spec type (CURRICULUM, MEASURE, IDENTITY, CONTENT, ADAPT, GUARDRAIL) |
| fileName | body | string | No | Original file name for ID generation |

**Response** `200`
```json
{ ok: true, spec: object, warnings: string[], needsReview: string[] }
```

**Response** `400`
```json
{ ok: false, error: "No content provided" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/specs/import

List all BDD feature sets stored in the database (used by import UI to show existing specs)

**Auth**: Session · **Scope**: `specs:read`

**Response** `200`
```json
{ ok: true, count: number, specs: BDDFeatureSet[] }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/specs/import

Import BDD spec files (.spec.json) via multipart form upload, upsert into database, and optionally activate

**Auth**: Session · **Scope**: `specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| autoActivate | body | boolean | No | Whether to activate specs after import (default: true) |

**Response** `200`
```json
{ ok: true, created: number, updated: number, errors: number, total: number, results: ImportResult[] }
```

**Response** `400`
```json
{ ok: false, error: "Expected multipart/form-data" }
```

**Response** `400`
```json
{ ok: false, error: "No files uploaded" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/specs/parse-document

AI-powered document type detection. Analyzes an uploaded file to determine the best BDD spec type (CURRICULUM, MEASURE, IDENTITY, etc.) and suggests an ID.

**Auth**: Session · **Scope**: `specs:write`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| file | body | File | No | The document to analyze (multipart/form-data) |

**Response** `200`
```json
{ ok: true, fileName: string, suggestedType: string, confidence: number, reasoning: string, detectedElements: string[], suggestedId: string }
```

**Response** `400`
```json
{ ok: false, error: "No file provided" }
```

**Response** `400`
```json
{ ok: false, error: "File is empty" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/specs/tree

Returns a hierarchical tree structure of ALL specs grouped by Domain > Scope > OutputType, with full trigger/action/parameter nesting

**Auth**: Session · **Scope**: `specs:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| active | query | string | No | Filter by active status: "true", "false", or "all" (default "all") |

**Response** `200`
```json
{ ok: true, tree: TreeNode, stats: { total, byDomain, byScope, byOutputType } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Subjects

### `POST` /api/subjects/:subjectId/upload

Drag-drop endpoint: upload a document, auto-create ContentSource,

**Auth**: OPERATOR · **Scope**: `subjects:write`

**Response** `202`
```json
{ ok, source, jobId, totalChunks }
```

---

## System

### `GET` /api/health

Basic liveness check. Returns OK with timestamp. Used by infrastructure probes and load balancers.

**Auth**: None · **Scope**: `system:health`

**Response** `200`
```json
{ ok: true, ts: "ISO8601" }
```

---

### `GET` /api/ready

Readiness probe that verifies database connectivity via a simple SELECT query.

**Auth**: None · **Scope**: `system:readiness`

**Response** `200`
```json
{ ok: true, db: "ok", ts: "ISO8601" }
```

**Response** `503`
```json
{ ok: false, db: "down", error: "..." }
```

---

### `GET` /api/system/readiness

Returns comprehensive system readiness status for the analyze workflow. Checks prerequisites (specs, parameters, run configs), data sources (callers, calls, transcripts), and suggests next actions.

**Auth**: None · **Scope**: `system:readiness`

**Response** `200`
```json
{ ok: true, ready: boolean, checks: {...}, sources: {...}, suggestedActions: [...], stats: {...}, timestamp: "ISO8601" }
```

**Response** `500`
```json
{ ok: false, ready: false, error: "...", checks: { database: { ok: false, message: "..." } } }
```

---

## Tasks

### `DELETE` /api/tasks

Marks a task as completed.

**Auth**: Session · **Scope**: `tasks:complete`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| taskId | query | string | No | Task ID to complete (required) |

**Response** `200`
```json
{ ok: true }
```

**Response** `400`
```json
{ ok: false, error: "taskId is required" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/tasks

Retrieves task guidance for a specific task ID, or lists tasks by status.

**Auth**: Session · **Scope**: `tasks:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| taskId | query | string | No | Specific task ID to get guidance for |
| status | query | string | No | Filter tasks by status |

**Response** `200`
```json
{ ok: true, guidance: {...} } | { ok: true, tasks: [...], count: number }
```

**Response** `400`
```json
{ ok: false, error: "taskId or status parameter is required" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/tasks

Starts a new task tracking session with a given task type and optional context.

**Auth**: Session · **Scope**: `tasks:create`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| taskType | body | string | No | Type of task to track (required) |
| userId | body | string | No | User ID (default: "default") |
| context | body | object | No | Additional task context |

**Response** `200`
```json
{ ok: true, taskId: "..." }
```

**Response** `400`
```json
{ ok: false, error: "taskType is required" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PUT` /api/tasks

Updates progress on an existing task.

**Auth**: Session · **Scope**: `tasks:update`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| taskId | body | string | No | Task ID to update (required) |
| updates | body | object | No | Progress updates to apply |

**Response** `200`
```json
{ ok: true }
```

**Response** `400`
```json
{ ok: false, error: "taskId is required" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Test Harness

### `POST` /api/test-harness/generate-callers

Batch-create N test callers in a domain. Returns SSE progress stream.

**Auth**: ADMIN

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | body | string | No | Target domain ID (required) |
| count | body | number | No | Number of callers to create (1-50, required) |
| namePrefix | body | string | No | Name prefix for callers (default "Test Caller") |

**Response** `200`
```json
text/event-stream
```

**Response** `400`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/test-harness/onboarding-call

Compose an onboarding prompt and create the first call record for a caller.

**Auth**: ADMIN

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | body | string | No | Caller to onboard (required) |
| runInitialGreeting | body | boolean | No | Generate AI's opening message (default true) |

**Response** `200`
```json
{ ok: true, prompt: object, call: object, greeting?: string }
```

**Response** `400`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/test-harness/run-sim

Run a fully automated AI-simulated call where AI plays both system and caller roles.

**Auth**: ADMIN

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| callerId | body | string | No | Caller to simulate (required) |
| turnCount | body | number | No | Number of conversation turns (2-20, default 6) |
| runPipeline | body | boolean | No | Run end-call pipeline after sim (default true) |

**Response** `200`
```json
text/event-stream
```

**Response** `400`
```json
{ ok: false, error: "..." }
```

---

## Tickets

### `GET` /api/tickets

Lists tickets with optional filters, pagination, and sorting. Includes creator/assignee details and comment counts.

**Auth**: Session · **Scope**: `tickets:list`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| status | query | string | No | Filter by ticket status |
| priority | query | string | No | Filter by priority level |
| category | query | string | No | Filter by category |
| assigneeId | query | string | No | Filter by assignee (use "unassigned" for null) |
| creatorId | query | string | No | Filter by creator |
| limit | query | number | No | Max tickets to return (default 50, max 100) |
| offset | query | number | No | Pagination offset (default 0) |

**Response** `200`
```json
{ ok: true, tickets: [...], total: number, limit: number, offset: number }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/tickets

Creates a new ticket. Validates assignee existence if provided.

**Auth**: Session · **Scope**: `tickets:create`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| title | body | string | No | Ticket title (required) |
| description | body | string | No | Ticket description (required) |
| priority | body | string | No | Priority level (default: "MEDIUM") |
| category | body | string | No | Ticket category (default: "OTHER") |
| assigneeId | body | string | No | User ID to assign (optional) |

**Response** `201`
```json
{ ok: true, ticket: {...} }
```

**Response** `400`
```json
{ ok: false, error: "Title is required" | "Description is required" }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `404`
```json
{ ok: false, error: "Assignee not found or inactive" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `DELETE` /api/tickets/:ticketId

Deletes a ticket. Only the ticket creator or an admin can delete.

**Auth**: Session · **Scope**: `tickets:delete`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| ticketId | path | string | Yes | The ticket ID |

**Response** `200`
```json
{ ok: true }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `403`
```json
{ ok: false, error: "Forbidden" }
```

**Response** `404`
```json
{ ok: false, error: "Ticket not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/tickets/:ticketId

Retrieves a single ticket by ID including all comments, creator, and assignee details.

**Auth**: Session · **Scope**: `tickets:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| ticketId | path | string | Yes | The ticket ID |

**Response** `200`
```json
{ ok: true, ticket: {...} }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `404`
```json
{ ok: false, error: "Ticket not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `PATCH` /api/tickets/:ticketId

Updates ticket fields (status, priority, category, assignee, title, description, tags). Manages resolved/closed timestamps automatically.

**Auth**: Session · **Scope**: `tickets:update`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| ticketId | path | string | Yes | The ticket ID |
| status | body | string | No | New status (OPEN, IN_PROGRESS, WAITING, RESOLVED, CLOSED) |
| priority | body | string | No | New priority |
| category | body | string | No | New category |
| assigneeId | body | string | No | New assignee user ID |
| title | body | string | No | Updated title |
| description | body | string | No | Updated description |

**Response** `200`
```json
{ ok: true, ticket: {...} }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `404`
```json
{ ok: false, error: "Ticket not found" | "Assignee not found or inactive" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/tickets/:ticketId/comments

Lists comments for a ticket with pagination. Includes author details.

**Auth**: Session · **Scope**: `tickets:comments-list`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| ticketId | path | string | Yes | The ticket ID |
| limit | query | number | No | Max comments to return (default 50, max 100) |
| offset | query | number | No | Pagination offset (default 0) |

**Response** `200`
```json
{ ok: true, comments: [...], total: number, limit: number, offset: number }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `404`
```json
{ ok: false, error: "Ticket not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `POST` /api/tickets/:ticketId/comments

Adds a comment to a ticket and updates the ticket's updatedAt timestamp.

**Auth**: Session · **Scope**: `tickets:comments-create`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| ticketId | path | string | Yes | The ticket ID |
| content | body | string | No | Comment text (required) |
| isInternal | body | boolean | No | Whether comment is internal-only (default: false) |

**Response** `201`
```json
{ ok: true, comment: {...} }
```

**Response** `400`
```json
{ ok: false, error: "Comment content is required" }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `404`
```json
{ ok: false, error: "Ticket not found" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/tickets/stats

Returns ticket statistics for dashboard badges. Includes counts by status, priority, and per-user assignment/creation counts.

**Auth**: Session · **Scope**: `tickets:stats`

**Response** `200`
```json
{ ok: true, stats: { byStatus: {...}, byPriority: {...}, myAssigned: number, myCreated: number, totalOpen: number } }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Transcripts

### `GET` /api/transcripts

React-Admin compatible endpoint for listing transcript files from configured sources directory. Supports JSON and TXT formats, pagination via Content-Range header, sorting, and search filtering.

**Auth**: None · **Scope**: `transcripts:list`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| sort | query | string | No | JSON array [field, order] e.g. ["modifiedAt", "DESC"] |
| range | query | string | No | JSON array [start, end] e.g. [0, 24] |
| filter | query | string | No | JSON object e.g. {"q": "search term"} |

**Response** `200`
```json
[{ id, filename, relativePath, path, sizeBytes, sizeMB, modifiedAt, callCount, date, type, status, fileHash, fileExt }]
```

**Response** `400`
```json
{ error: "Path is not a directory: ..." }
```

**Response** `500`
```json
{ error: "..." }
```

---

### `POST` /api/transcripts/import

Imports transcript files into the database. Supports three modes: JSON body with filePaths, JSON body with fromKbPath auto-discovery, or FormData file uploads. Includes preview mode for conflict detection and user-controlled conflict resolution.

**Auth**: None · **Scope**: `transcripts:import`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| fromKbPath | body | boolean | No | Auto-discover from HF_KB_PATH/sources/transcripts/raw (JSON mode) |
| domainSlug | body | string | No | Domain slug for created callers (default: "mabel") |
| duplicateHandling | body | string | No | "skip" | "overwrite" | "create_new" (default: "skip") |
| preview | body | boolean | No | If true, only detect conflicts without importing |
| conflictResolutions | body | object | No | Map of conflictKey to "merge" | "create_new" | "skip" |

**Response** `200`
```json
{ ok: true, created: number, merged: number, updated: number, skipped: number, callers: [...], filesProcessed: number, callsImported: number, errors: [...] }
```

**Response** `400`
```json
{ ok: false, error: "No files uploaded" | "No files specified..." }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/transcripts/raw-files

Lists raw transcript files from the sources/transcripts/raw directory. Recursively finds .json (VAPI exports) and .txt (session transcripts) files with metadata.

**Auth**: Session · **Scope**: `transcripts:raw-files`

**Response** `200`
```json
{ ok: true, files: [{ name, path, relativePath, size, modifiedAt, format }], directory: "...", kbRoot: "...", count: number }
```

**Response** `500`
```json
{ ok: false, error: "...", files: [] }
```

---

## Users

### `DELETE` /api/invites

Deletes an invite by ID. Admin-only.

**Auth**: Session · **Scope**: `invites:delete`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| id | query | string | No | Invite ID to delete |

**Response** `200`
```json
{ success: true }
```

**Response** `400`
```json
{ error: "Invite ID required" }
```

**Response** `401`
```json
{ error: "Unauthorized" }
```

**Response** `403`
```json
{ error: "Forbidden" }
```

---

### `GET` /api/invites

Lists all invites, ordered by creation date. Admin-only.

**Auth**: Session · **Scope**: `invites:list`

**Response** `200`
```json
{ invites: [...] }
```

**Response** `401`
```json
{ error: "Unauthorized" }
```

**Response** `403`
```json
{ error: "Forbidden" }
```

---

### `POST` /api/invites

Creates a new invite for a field tester and sends magic link email. Expires in 7 days. Admin-only.

**Auth**: Session · **Scope**: `invites:create`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| email | body | string | No | Email address to invite (required) |
| role | body | string | No | User role (default: "OPERATOR") |
| firstName | body | string | No | Tester's first name (optional, pre-fills accept form) |
| lastName | body | string | No | Tester's last name (optional, pre-fills accept form) |
| domainId | body | string | No | Lock tester to specific domain (optional, null = domain chooser) |
| sendEmail | body | boolean | No | Whether to send the invite email (default: true) |

**Response** `201`
```json
{ ok: true, invite: {...}, inviteUrl: string }
```

**Response** `400`
```json
{ error: "Email is required" | "User already exists..." | "Invalid domain ID" | ... }
```

**Response** `401`
```json
{ error: "Unauthorized" }
```

**Response** `403`
```json
{ error: "Forbidden" }
```

---

### `GET` /api/users

Lists callers with optional personality profile inclusion. Supports pagination via limit.

**Auth**: Session · **Scope**: `users:list`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| withPersonality | query | boolean | No | Include personality profile data |
| limit | query | number | No | Max callers to return (default 50) |

**Response** `200`
```json
{ ok: true, callers: [...], count: number }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/users-list

Returns active admin users for dropdown selection (assignee, recipient, etc.). Requires authenticated session.

**Auth**: Session · **Scope**: `users:list`

**Response** `200`
```json
{ ok: true, users: [{ id, name, email, image }], debug: { total, active } }
```

**Response** `401`
```json
{ ok: false, error: "Unauthorized" }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/users/personality

Returns the most recent 100 caller personality profiles with associated caller details (name, email, externalId).

**Auth**: Session · **Scope**: `users:personality`

**Response** `200`
```json
{ ok: true, profiles: [...], count: number }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Vapi

### `POST` /api/vapi/assistant-request

VAPI calls this at call start to get a per-caller assistant config.

**Auth**: webhook-secret · **Scope**: `vapi:assistant`

---

### `POST` /api/vapi/knowledge

VAPI Custom Knowledge Base endpoint. Called every conversation turn.

**Auth**: webhook-secret · **Scope**: `vapi:knowledge`

---

### `POST` /api/vapi/tools

VAPI Custom Tools endpoint. Called when the voice AI decides

**Auth**: webhook-secret · **Scope**: `vapi:tools`

---

### `POST` /api/vapi/webhook

Receives VAPI webhook events. Handles end-of-call-report to

**Auth**: webhook-secret · **Scope**: `vapi:webhook`

---

## Visualizations

### `GET` /api/supervisor

Returns pipeline configuration and specs organized by stage for a domain. Shows which specs will run at each pipeline stage, including SYSTEM specs (always enabled) and DOMAIN specs (from published playbook). Pipeline stages are loaded from PIPELINE-001 spec (or GUARD-001 fallback).

**Auth**: Session · **Scope**: `supervisor:read`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| domainId | query | string | No | If provided, shows DOMAIN specs for that domain |

**Response** `200`
```json
{ ok: true, superviseSpec: {...}, domain: {...}, playbook: {...}, stages: [...], allDomains: [...], counts: {...} }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/taxonomy-graph

Returns nodes and edges for the taxonomy graph visualization. Includes specs, parameters, playbooks, domains, triggers, actions, anchors, prompt slugs, behavior targets, and ranges. Supports focused subgraph queries and minimal mode.

**Auth**: Session · **Scope**: `visualizations:taxonomy`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| focus | query | string | No | Node ID to center on (returns only connected nodes within depth) |
| depth | query | number | No | How many hops from focus node (default 2) |
| minimal | query | string | No | If "1", excludes pipeline-only implementation details (triggers, actions) |

**Response** `200`
```json
{ ok: true, nodes: [...], edges: [...], counts: { nodes, edges, byType: {...} }, orphans: { total, byType: {...} } }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

### `GET` /api/taxonomy-tree

Returns a hierarchical tree of the full taxonomy:

**Auth**: Session · **Scope**: `visualizations:taxonomy`

**Response** `200`
```json
{ ok: true, tree: TreeNode[], stats: {...} }
```

**Response** `500`
```json
{ ok: false, error: "..." }
```

---

## Workflow

### `POST` /api/ai/workflow/classify

Multi-turn discovery conversation for guided workflow planning.

**Auth**: Session · **Scope**: `workflow:create`

| Parameter | In | Type | Required | Description |
|-----------|-----|------|----------|-------------|
| message | body | string | No | User's message |
| history | body | Array | No | Conversation history [{role, content}] |

**Response** `200`
```json
{ ok, response, plan?, planReady? }
```

---

## Architecture Notes

### Middleware stack

All API routes pass through the following middleware chain:

1. **Rate limiter** -- Token-bucket per IP / API key
2. **Auth resolver** -- Extracts session cookie or Bearer token
3. **Scope checker** -- Validates API key scopes against endpoint requirements
4. **Request logger** -- Logs method, path, duration, status

### Prisma patterns

- Use `prisma.$transaction()` for multi-table writes.
- Prefer `include` over separate queries to avoid N+1.
- Use `select` when you only need a few fields.
- Never call `findMany()` without a `where` clause on large tables.

### Streaming responses

Pipeline and prompt-composition endpoints support streaming via
Server-Sent Events (SSE):

```typescript
// Return a streaming response
return new Response(stream, {
  headers: {
    "Content-Type": "text/event-stream",
    "Cache-Control": "no-cache",
    Connection: "keep-alive",
  },
});
```

### Error handling conventions

All API routes follow the same pattern:

```typescript
try {
  // ... business logic
  return NextResponse.json({ ok: true, data });
} catch (error: any) {
  console.error("METHOD /api/path error:", error);
  return NextResponse.json(
    { ok: false, error: error?.message || "Operation failed" },
    { status: 500 }
  );
}
```

### Internal-only endpoints

Endpoints with `@auth internal` require the `x-internal-secret` header.
These are used for server-to-server communication (e.g., pipeline
orchestration between services) and are never exposed externally.

---

## Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `DATABASE_URL` | Yes | -- | PostgreSQL connection string |
| `HF_SUPERADMIN_TOKEN` | Yes | -- | Bearer token for admin endpoints |
| `OPENAI_API_KEY` | Yes | -- | OpenAI API key for LLM calls |
| `NEXTAUTH_SECRET` | Yes | -- | NextAuth session encryption key |
| `NEXTAUTH_URL` | Yes | -- | Canonical URL of the app |
| `HF_KB_PATH` | No | `./kb` | Path to knowledge base files |
| `HF_LOG_LEVEL` | No | `info` | Log level: debug, info, warn, error |
| `HF_INTERNAL_SECRET` | No | -- | Secret for `x-internal-secret` header |
| `ANTHROPIC_API_KEY` | No | -- | Anthropic API key (Claude models) |
| `HF_RATE_LIMIT_RPM` | No | `600` | Rate limit: requests per minute |
| `HF_PIPELINE_TIMEOUT` | No | `30000` | Pipeline execution timeout (ms) |
| `HF_WEBHOOK_SECRET` | No | -- | HMAC secret for outbound webhook signatures |
| `HF_CORS_ORIGINS` | No | `*` | Comma-separated allowed CORS origins |
| `REDIS_URL` | No | -- | Redis URL for caching and rate limiting |

---

## Coverage

| Metric | Value |
|--------|-------|
| Route files found | 241 |
| Files with annotations | 234 |
| Files missing annotations | 7 |
| Coverage | 97.1% |

### Files missing `@api` annotations

- `app/api/content-fragments/route.ts`
- `app/api/content-sources/route.ts`
- `app/api/subjects/[subjectId]/curriculum/route.ts`
- `app/api/subjects/[subjectId]/domains/route.ts`
- `app/api/subjects/[subjectId]/route.ts`
- `app/api/subjects/[subjectId]/sources/route.ts`
- `app/api/subjects/route.ts`
