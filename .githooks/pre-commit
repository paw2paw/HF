#!/usr/bin/env bash
set -euo pipefail

# ------------------------------------------------------------
# pre-commit (HF)
# - Guardrails (blocking): prevent known foot-guns
# - Automation (non-blocking): regenerate docs, update qmd
# ------------------------------------------------------------

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Only consider staged adds/copies/modifies/renames
STAGED_FILES="$(git diff --cached --name-only --diff-filter=ACMR || true)"

if [[ -z "${STAGED_FILES}" ]]; then
  exit 0
fi

# ----------------------------
# A) BLOCKING GUARDRAILS
# ----------------------------

# 1) Prevent TDZ/shadowing bug:
# If a file imports { config } from "@/lib/config" then forbid a local `const|let|var config =`
# (Keeps behavior predictable and avoids accidental shadowing.)
violations=""
while IFS= read -r f; do
  [[ -z "$f" ]] && continue
  [[ ! -f "$f" ]] && continue

  if rg -n 'import\s*\{\s*config\s*\}\s*from\s*["'"'"']@/lib/config["'"'"']' "$f" >/dev/null 2>&1; then
    if rg -n '^\s*(const|let|var)\s+config\s*=' "$f" >/dev/null 2>&1; then
      violations+="$f"$'\n'
    fi
  fi
done <<< "${STAGED_FILES}"

if [[ -n "$violations" ]]; then
  echo "[pre-commit] ERROR: config shadowing detected in staged files:"
  echo "$violations" | sed '/^$/d' | sed 's/^/  - /'
  echo
  echo "Fix: rename local `config` to `specConfig` / `aiConfigRow` / etc."
  echo "Tip: VS Code -> place cursor on local `config` -> F2 Rename Symbol."
  exit 1
fi

# ----------------------------
# B) NON-BLOCKING AUTOMATIONS
# ----------------------------

# 2) Auto-regenerate API docs when route files change
# Detect staged changes to apps/admin/app/api/**/route.ts
route_changes_count="$(printf '%s\n' "$STAGED_FILES" | rg -c '^apps/admin/app/api/.*route\.ts$' || true)"
if [[ "${route_changes_count}" -gt 0 ]]; then
  echo "[pre-commit] Route files changed — regenerating API docs..."

  (
    cd apps/admin
    # If generator fails, we do NOT block commit (CI can catch)
    npx tsx scripts/api-docs/generator.ts >/dev/null 2>&1
  ) || {
    code=$?
    echo "[pre-commit] ⚠ API docs generator failed (exit $code). Commit continues."
    exit 0
  }

  # Stage regenerated docs (ignore if missing)
  git add docs/API-INTERNAL.md docs/API-PUBLIC.md >/dev/null 2>&1 || true
  echo "[pre-commit] API docs regenerated and staged."
fi

# 3) Auto-update QMD index on code changes (Mac only, non-blocking)
# Only run if qmd exists AND relevant files changed.
if command -v qmd >/dev/null 2>&1; then
  qmd_input_changed="0"
  while IFS= read -r f; do
    [[ -z "$f" ]] && continue
    case "$f" in
      *.md|*.mdx|*.txt|*.ts|*.tsx|*.js|*.jsx|*.json|*.yaml|*.yml|*.prisma|*.sql|*.sh)
        qmd_input_changed="1"
        break
        ;;
      *)
        ;;
    esac
  done <<< "${STAGED_FILES}"

  if [[ "$qmd_input_changed" == "1" ]]; then
    echo "[pre-commit] Updating QMD index..."
    qmd update --quiet >/dev/null 2>&1 || echo "[pre-commit] ⚠ QMD update failed (non-blocking)"
    echo "[pre-commit] Embedding QMD documents..."
    qmd embed --quiet >/dev/null 2>&1 || echo "[pre-commit] ⚠ QMD embed failed (non-blocking)"
  fi
fi

exit 0
