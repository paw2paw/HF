name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      run_migrations:
        description: "Run schema migrations before deploy"
        type: boolean
        default: false
      run_seed:
        description: "Re-seed specs after deploy"
        type: boolean
        default: false

concurrency:
  group: deploy-prod
  cancel-in-progress: false

env:
  PROJECT_ID: hf-admin-prod
  REGION: europe-west2
  REGISTRY: europe-west2-docker.pkg.dev/hf-admin-prod/hf-docker
  SERVICE: hf-admin

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/311250123759/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-deploy@hf-admin-prod.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker europe-west2-docker.pkg.dev --quiet

      - name: Build runner image
        run: |
          docker build --platform linux/amd64 --target runner \
            -t ${{ env.REGISTRY }}/hf-admin:latest \
            -t ${{ env.REGISTRY }}/hf-admin:prod-${{ github.sha }} \
            -f apps/admin/Dockerfile apps/admin

      - name: Build seed image
        if: ${{ inputs.run_migrations || inputs.run_seed }}
        run: |
          docker build --platform linux/amd64 --target seed \
            -t ${{ env.REGISTRY }}/hf-seed:latest \
            -f apps/admin/Dockerfile apps/admin

      - name: Push images
        run: |
          docker push ${{ env.REGISTRY }}/hf-admin:latest
          docker push ${{ env.REGISTRY }}/hf-admin:prod-${{ github.sha }}
          if [ "${{ inputs.run_migrations || inputs.run_seed }}" = "true" ]; then
            docker push ${{ env.REGISTRY }}/hf-seed:latest
          fi

      - name: Run schema migration
        if: ${{ inputs.run_migrations }}
        run: |
          gcloud run jobs update hf-migrate \
            --image=${{ env.REGISTRY }}/hf-seed:latest \
            --region=${{ env.REGION }}
          gcloud run jobs execute hf-migrate \
            --region=${{ env.REGION }} --wait

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE }} \
            --image=${{ env.REGISTRY }}/hf-admin:latest \
            --region=${{ env.REGION }}

      - name: Re-seed specs
        if: ${{ inputs.run_seed }}
        run: |
          gcloud run jobs update hf-seed \
            --image=${{ env.REGISTRY }}/hf-seed:latest \
            --region=${{ env.REGION }}
          gcloud run jobs execute hf-seed \
            --region=${{ env.REGION }} --wait

      - name: Smoke test
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "Testing $URL..."

          for i in $(seq 1 12); do
            if curl -sf "$URL/api/health" > /dev/null 2>&1; then
              echo "Health check passed"
              break
            fi
            echo "Waiting for service... (attempt $i/12)"
            sleep 5
          done

          curl -sf "$URL/api/health" | jq .
          curl -sf "$URL/api/ready" | jq .
